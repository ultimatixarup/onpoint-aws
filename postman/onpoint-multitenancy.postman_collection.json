{
  "info": {
    "name": "OnPoint - Multi-Tenancy Tests",
    "_postman_id": "d2d2e0f3-2f2b-4f9a-9a0c-3a6c7a6b0f6e",
    "description": "Multi-tenancy validation for Trip Summary APIs (VIN registry + tenant isolation). Uses tripSummaryBaseUrl and tripSummaryApiKey from the environment.",
    "schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json"
  },
  "event": [
    {
      "listen": "prerequest",
      "script": {
        "type": "text/javascript",
        "exec": [
          "const baseUrl = pm.environment.get('tripSummaryBaseUrl');",
          "const apiKey = pm.environment.get('tripSummaryApiKey');",
          "if (baseUrl) {",
          "  pm.variables.set('baseUrl', baseUrl);",
          "}",
          "if (apiKey) {",
          "  pm.variables.set('apiKey', apiKey);",
          "}",
          "const url = pm.request.url.toString();",
          "const headers = {};",
          "pm.request.headers.each(h => {",
          "  const key = h.key || '';",
          "  headers[key] = key.toLowerCase() === 'x-api-key' ? '***' : h.value;",
          "});",
          "console.log('Request URL:', url);",
          "console.log('Headers (redacted API key):', headers);"
        ]
      }
    }
  ],
  "item": [
    {
      "name": "Trip Events (Allowed Tenant)",
      "request": {
        "method": "GET",
        "header": [
          { "key": "x-api-key", "value": "{{tripSummaryApiKey}}" },
          { "key": "x-tenant-id", "value": "{{tenantId}}" },
          { "key": "Content-Type", "value": "application/json" }
        ],
        "url": {
          "raw": "{{tripSummaryBaseUrl}}/trips/{{vinAllowed}}/{{tripId}}/events?limit={{limit}}",
          "host": ["{{tripSummaryBaseUrl}}"],
          "path": ["trips", "{{vinAllowed}}", "{{tripId}}", "events"],
          "query": [{ "key": "limit", "value": "{{limit}}" }]
        }
      },
      "event": [
        {
          "listen": "test",
          "script": {
            "type": "text/javascript",
            "exec": [
              "pm.test('Status is 200', () => pm.response.to.have.status(200));",
              "const json = pm.response.json();",
              "pm.test('Response shape', () => {",
              "  pm.expect(json).to.have.property('vin');",
              "  pm.expect(json).to.have.property('tripId');",
              "  pm.expect(json).to.have.property('items');",
              "  pm.expect(json.items).to.be.an('array');",
              "});",
              "pm.test('No summary payload', () => {",
              "  pm.expect(json).to.not.have.property('summary');",
              "});"
            ]
          }
        }
      ]
    },
    {
      "name": "Trip Events (Forbidden Tenant)",
      "request": {
        "method": "GET",
        "header": [
          { "key": "x-api-key", "value": "{{tripSummaryApiKey}}" },
          { "key": "x-tenant-id", "value": "{{tenantIdForbidden}}" }
        ],
        "url": {
          "raw": "{{tripSummaryBaseUrl}}/trips/{{vinForbidden}}/{{tripId}}/events?limit={{limit}}",
          "host": ["{{tripSummaryBaseUrl}}"],
          "path": ["trips", "{{vinForbidden}}", "{{tripId}}", "events"],
          "query": [{ "key": "limit", "value": "{{limit}}" }]
        }
      },
      "event": [
        {
          "listen": "test",
          "script": {
            "type": "text/javascript",
            "exec": [
              "pm.test('Status is 403', () => pm.response.to.have.status(403));",
              "pm.test('Error is Forbidden', () => {",
              "  const json = pm.response.json();",
              "  pm.expect(json.error).to.eql('Forbidden');",
              "});"
            ]
          }
        }
      ]
    },
    {
      "name": "Trip Detail (Allowed Tenant)",
      "request": {
        "method": "GET",
        "header": [
          { "key": "x-api-key", "value": "{{tripSummaryApiKey}}" },
          { "key": "x-tenant-id", "value": "{{tenantId}}" }
        ],
        "url": {
          "raw": "{{tripSummaryBaseUrl}}/trips/{{vinAllowed}}/{{tripId}}?include=summary",
          "host": ["{{tripSummaryBaseUrl}}"],
          "path": ["trips", "{{vinAllowed}}", "{{tripId}}"],
          "query": [{ "key": "include", "value": "summary" }]
        }
      },
      "event": [
        {
          "listen": "test",
          "script": {
            "type": "text/javascript",
            "exec": [
              "pm.test('Status is 200', () => pm.response.to.have.status(200));",
              "const json = pm.response.json();",
              "pm.test('Has vin/tripId', () => {",
              "  pm.expect(json).to.have.property('vin');",
              "  pm.expect(json).to.have.property('tripId');",
              "});"
            ]
          }
        }
      ]
    },
    {
      "name": "Trip Detail (Forbidden Tenant)",
      "request": {
        "method": "GET",
        "header": [
          { "key": "x-api-key", "value": "{{tripSummaryApiKey}}" },
          { "key": "x-tenant-id", "value": "{{tenantIdForbidden}}" }
        ],
        "url": {
          "raw": "{{tripSummaryBaseUrl}}/trips/{{vinForbidden}}/{{tripId}}",
          "host": ["{{tripSummaryBaseUrl}}"],
          "path": ["trips", "{{vinForbidden}}", "{{tripId}}"]
        }
      },
      "event": [
        {
          "listen": "test",
          "script": {
            "type": "text/javascript",
            "exec": [
              "pm.test('Status is 403', () => pm.response.to.have.status(403));",
              "pm.test('Error is Forbidden', () => {",
              "  const json = pm.response.json();",
              "  pm.expect(json.error).to.eql('Forbidden');",
              "});"
            ]
          }
        }
      ]
    },
    {
      "name": "List Trips (Allowed Tenant)",
      "request": {
        "method": "GET",
        "header": [
          { "key": "x-api-key", "value": "{{tripSummaryApiKey}}" },
          { "key": "x-tenant-id", "value": "{{tenantId}}" }
        ],
        "url": {
          "raw": "{{tripSummaryBaseUrl}}/trips?vehicleId={{vinAllowed}}&limit=10",
          "host": ["{{tripSummaryBaseUrl}}"],
          "path": ["trips"],
          "query": [
            { "key": "vehicleId", "value": "{{vinAllowed}}" },
            { "key": "limit", "value": "10" }
          ]
        }
      },
      "event": [
        {
          "listen": "test",
          "script": {
            "type": "text/javascript",
            "exec": [
              "pm.test('Status is 200', () => pm.response.to.have.status(200));",
              "const json = pm.response.json();",
              "pm.test('Has items array', () => {",
              "  pm.expect(json).to.have.property('items');",
              "  pm.expect(json.items).to.be.an('array');",
              "});",
              "pm.test('Allowed list trips includes startMiles/endMiles when items exist', () => {",
              "  if (json.items.length > 0) {",
              "    const item = json.items[0];",
              "    pm.expect(item).to.have.property('startMiles');",
              "    pm.expect(item).to.have.property('endMiles');",
              "    pm.expect(item.startMiles).to.be.a('number');",
              "    pm.expect(item.endMiles).to.be.a('number');",
              "});"
            ]
          }
        }
      ]
    },
    {
      "name": "List Trips (Forbidden Tenant)",
      "request": {
        "method": "GET",
        "header": [
          { "key": "x-api-key", "value": "{{tripSummaryApiKey}}" },
          { "key": "x-tenant-id", "value": "{{tenantIdForbidden}}" }
        ],
        "url": {
          "raw": "{{tripSummaryBaseUrl}}/trips?vehicleId={{vinForbidden}}&limit=10",
          "host": ["{{tripSummaryBaseUrl}}"],
          "path": ["trips"],
          "query": [
            { "key": "vehicleId", "value": "{{vinForbidden}}" },
            { "key": "limit", "value": "10" }
          ]
        }
      },
      "event": [
        {
          "listen": "test",
          "script": {
            "type": "text/javascript",
            "exec": [
              "pm.test('Status is 403', () => pm.response.to.have.status(403));",
              "pm.test('Error is Forbidden', () => {",
              "  const json = pm.response.json();",
              "  pm.expect(json.error).to.eql('Forbidden');",
              "});"
            ]
          }
        }
      ]
    }
  ]
}
