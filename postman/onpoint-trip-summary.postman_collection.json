{
  "info": {
    "name": "OnPoint - Trip Summary API",
    "_postman_id": "b4c8d3e4-3d6c-5c9b-9d1f-1c3b2a4f0e5f",
    "description": "Trip Summary REST API - Query trip summaries and details. Uses tripSummaryBaseUrl and tripSummaryApiKey from the environment. Requests default x-role to admin unless overridden by tripSummaryRole/role.",
    "schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json"
  },
  "event": [
    {
      "listen": "prerequest",
      "script": {
        "type": "text/javascript",
        "exec": [
          "const baseUrl = pm.environment.get('tripSummaryBaseUrl');",
          "const apiKey = pm.environment.get('tripSummaryApiKey');",
          "if (apiKey) {",
          "  pm.variables.set('apiKey', apiKey);",
          "}",
          "const url = pm.request.url.toString();",
          "const tenantId = pm.environment.get('tripSummaryTenantId') || pm.environment.get('tenantId');",
          "const role = pm.environment.get('tripSummaryRole') || pm.environment.get('role') || pm.environment.get('roleAdmin') || 'admin';",
          "if (tenantId) {",
          "  pm.request.headers.upsert({ key: 'x-tenant-id', value: tenantId });",
          "}",
          "pm.request.headers.upsert({ key: 'x-role', value: role });",
          "const headers = {};",
          "pm.request.headers.each(h => {",
          "  const key = h.key || '';",
          "  headers[key] = key.toLowerCase() === 'x-api-key' ? '***' : h.value;",
          "});",
          "console.log('Request URL:', url);",
          "console.log('Headers (redacted API key):', headers);"
        ]
      }
    }
  ],
  "item": [
    {
      "name": "List Trips - Single Vehicle",
      "request": {
        "method": "GET",
        "header": [
          {
            "key": "x-api-key",
            "value": "{{tripSummaryApiKey}}",
            "type": "text"
          },
          {
            "key": "Content-Type",
            "value": "application/json",
            "type": "text"
          }
        ],
        "url": {
          "raw": "{{tripSummaryBaseUrl}}/trips?vehicleId={{testVin}}&limit=10",
          "host": ["{{tripSummaryBaseUrl}}"],
          "path": ["trips"],
          "query": [
            {
              "key": "vehicleId",
              "value": "{{testVin}}",
              "description": "Single VIN to query"
            },
            {
              "key": "limit",
              "value": "10",
              "description": "Max results (default 50, max 200)"
            },
            {
              "key": "include",
              "value": "none",
              "description": "none (fast) or summary (includes full summary JSON)",
              "disabled": true
            },
            {
              "key": "from",
              "value": "2026-01-01T00:00:00Z",
              "description": "ISO8601 start time filter",
              "disabled": true
            },
            {
              "key": "to",
              "value": "2026-01-31T23:59:59Z",
              "description": "ISO8601 end time filter",
              "disabled": true
            },
            {
              "key": "nextToken",
              "value": "",
              "description": "Pagination token from previous response",
              "disabled": true
            }
          ]
        },
        "description": "List trip summaries for a single vehicle. Returns top-level rollup fields by default (include=none), including driverId/driverName when assignment resolution succeeds."
      },
      "event": [
        {
          "listen": "test",
          "script": {
            "type": "text/javascript",
            "exec": [
              "pm.test('Status is 200', () => {",
              "  pm.response.to.have.status(200);",
              "});",
              "",
              "pm.test('Response has items array', () => {",
              "  const json = pm.response.json();",
              "  pm.expect(json).to.have.property('items');",
              "  pm.expect(json.items).to.be.an('array');",
              "});",
              "",
              "pm.test('Items have required fields', () => {",
              "  const json = pm.response.json();",
              "  if (json.items.length > 0) {",
              "    const item = json.items[0];",
              "    pm.expect(item).to.have.property('vin');",
              "    pm.expect(item).to.have.property('tripId');",
              "    pm.expect(item).to.have.property('startTime');",
              "    pm.expect(item).to.have.property('endTime');",
              "    pm.expect(item).to.have.property('startMiles');",
              "    pm.expect(item).to.have.property('endMiles');",
              "  }",
              "});",
              "",
              "pm.test('List response includes odometer fields when items exist', () => {",
              "  const json = pm.response.json();",
              "  if (json.items.length > 0) {",
              "    const item = json.items[0];",
              "    pm.expect(item.startMiles).to.be.a('number');",
              "    pm.expect(item.endMiles).to.be.a('number');",
              "    pm.expect(item.endMiles).to.be.at.least(item.startMiles);",
              "  }",
              "});",
              "",
              "pm.test('Driver enrichment fields appear when assignments resolve', () => {",
              "  const json = pm.response.json();",
              "  if (json.items.length > 0) {",
              "    const hasDriverFields = json.items.some((row) =>",
              "      Object.prototype.hasOwnProperty.call(row, 'driverId') ||",
              "      Object.prototype.hasOwnProperty.call(row, 'driverName')",
              "    );",
              "    if (!hasDriverFields) {",
              "      console.warn('No driverId/driverName fields found. This can happen when no matching assignment exists for returned trips.');",
              "    }",
              "    pm.expect(true).to.equal(true);",
              "  }",
              "});",
              "",
              "pm.test('No unauthorized errors', () => {",
              "  const text = pm.response.text();",
              "  pm.expect(text).to.not.include('Unauthorized');",
              "  pm.expect(text).to.not.include('Missing Authentication Token');",
              "  pm.expect(text).to.not.include('Forbidden');",
              "});"
            ]
          }
        }
      ]
    },
    {
      "name": "List Trips - Fleet",
      "request": {
        "method": "GET",
        "header": [
          {
            "key": "x-api-key",
            "value": "{{tripSummaryApiKey}}",
            "type": "text"
          }
        ],
        "url": {
          "raw": "{{tripSummaryBaseUrl}}/fleets/{{fleetId}}/trips?limit=20",
          "host": ["{{tripSummaryBaseUrl}}"],
          "path": ["fleets", "{{fleetId}}", "trips"],
          "query": [
            {
              "key": "limit",
              "value": "20",
              "description": "Max results (default 50, max 200)"
            },
            {
              "key": "include",
              "value": "none",
              "description": "none (fast) or summary (includes full summary JSON)",
              "disabled": true
            },
            {
              "key": "from",
              "value": "2026-01-01T00:00:00Z",
              "description": "ISO8601 start time filter",
              "disabled": true
            },
            {
              "key": "to",
              "value": "2026-01-31T23:59:59Z",
              "description": "ISO8601 end time filter",
              "disabled": true
            },
            {
              "key": "nextToken",
              "value": "",
              "description": "Pagination token from previous response",
              "disabled": true
            }
          ]
        },
        "description": "List trip summaries for a fleet (VINs resolved via VIN registry). Rows may include driverId/driverName when assignment resolution succeeds."
      },
      "event": [
        {
          "listen": "test",
          "script": {
            "type": "text/javascript",
            "exec": [
              "pm.test('Status is 200', () => pm.response.to.have.status(200));",
              "",
              "pm.test('Response has items array', () => {",
              "  const json = pm.response.json();",
              "  pm.expect(json).to.have.property('items');",
              "  pm.expect(json.items).to.be.an('array');",
              "});",
              "",
              "pm.test('Fleet list includes startMiles/endMiles when items exist', () => {",
              "  const json = pm.response.json();",
              "  if (json.items.length > 0) {",
              "    const item = json.items[0];",
              "    pm.expect(item).to.have.property('startMiles');",
              "    pm.expect(item).to.have.property('endMiles');",
              "    pm.expect(item.startMiles).to.be.a('number');",
              "    pm.expect(item.endMiles).to.be.a('number');",
              "  }",
              "});",
              "",
              "pm.test('Fleet list may include driver enrichment fields', () => {",
              "  const json = pm.response.json();",
              "  if (json.items.length > 0) {",
              "    const hasDriverFields = json.items.some((row) =>",
              "      Object.prototype.hasOwnProperty.call(row, 'driverId') ||",
              "      Object.prototype.hasOwnProperty.call(row, 'driverName')",
              "    );",
              "    if (!hasDriverFields) {",
              "      console.warn('No driverId/driverName fields found in current fleet response.');",
              "    }",
              "    pm.expect(true).to.equal(true);",
              "  }",
              "});"
            ]
          }
        }
      ]
    },
    {
      "name": "List Trips - Multiple Vehicles",
      "request": {
        "method": "GET",
        "header": [
          {
            "key": "x-api-key",
            "value": "{{tripSummaryApiKey}}",
            "type": "text"
          }
        ],
        "url": {
          "raw": "{{tripSummaryBaseUrl}}/trips?vehicleIds=VIN1,VIN2,VIN3&limit=20",
          "host": ["{{tripSummaryBaseUrl}}"],
          "path": ["trips"],
          "query": [
            {
              "key": "vehicleIds",
              "value": "VIN1,VIN2,VIN3",
              "description": "Comma-separated VINs (bounded fan-out)"
            },
            {
              "key": "limit",
              "value": "20"
            }
          ]
        },
        "description": "Query trip summaries across multiple vehicles (bounded fan-out)."
      },
      "event": [
        {
          "listen": "test",
          "script": {
            "type": "text/javascript",
            "exec": [
              "pm.test('Status is 200', () => pm.response.to.have.status(200));",
              "",
              "pm.test('Response has items', () => {",
              "  const json = pm.response.json();",
              "  pm.expect(json).to.have.property('items');",
              "});"
            ]
          }
        }
      ]
    },
    {
      "name": "Trip History Page List (UI parity)",
      "request": {
        "method": "GET",
        "header": [
          {
            "key": "x-api-key",
            "value": "{{tripSummaryApiKey}}",
            "type": "text"
          },
          {
            "key": "x-tenant-id",
            "value": "{{tripSummaryTenantId}}",
            "type": "text"
          }
        ],
        "url": {
          "raw": "{{tripSummaryBaseUrl}}/fleets/{{fleetId}}/trips?limit=20",
          "host": ["{{tripSummaryBaseUrl}}"],
          "path": ["fleets", "{{fleetId}}", "trips"],
          "query": [
            {
              "key": "limit",
              "value": "20",
              "description": "Matches UI default list page size"
            },
            {
              "key": "from",
              "value": "2026-01-01T00:00:00Z",
              "disabled": true,
              "description": "Optional date filter used by UI range picker"
            },
            {
              "key": "to",
              "value": "2026-01-31T23:59:59Z",
              "disabled": true,
              "description": "Optional date filter used by UI range picker"
            }
          ]
        },
        "description": "Mirrors Trip History list call: GET /fleets/{fleetId}/trips with x-tenant-id + x-api-key. Returns top-level startMiles/endMiles and may include driverId/driverName for list rows."
      },
      "event": [
        {
          "listen": "test",
          "script": {
            "type": "text/javascript",
            "exec": [
              "pm.test('Status is 200', () => pm.response.to.have.status(200));",
              "const json = pm.response.json();",
              "",
              "pm.test('Response has items array', () => {",
              "  pm.expect(json).to.have.property('items');",
              "  pm.expect(json.items).to.be.an('array');",
              "});",
              "",
              "pm.test('Trip list rows include odometer fields', () => {",
              "  if (json.items.length > 0) {",
              "    const row = json.items[0];",
              "    pm.expect(row).to.have.property('startMiles');",
              "    pm.expect(row).to.have.property('endMiles');",
              "    pm.expect(row.startMiles).to.be.a('number');",
              "    pm.expect(row.endMiles).to.be.a('number');",
              "    pm.expect(row.endMiles).to.be.at.least(row.startMiles);",
              "  }",
              "});",
              "",
              "pm.test('Trip History list includes driver enrichment when available', () => {",
              "  if (json.items.length > 0) {",
              "    const hasDriverFields = json.items.some((row) =>",
              "      Object.prototype.hasOwnProperty.call(row, 'driverId') ||",
              "      Object.prototype.hasOwnProperty.call(row, 'driverName')",
              "    );",
              "    if (!hasDriverFields) {",
              "      console.warn('No driver enrichment fields found for returned rows.');",
              "    }",
              "    pm.expect(true).to.equal(true);",
              "  }",
              "});"
            ]
          }
        }
      ]
    },
    {
      "name": "List Trips - With Summary",
      "request": {
        "method": "GET",
        "header": [
          {
            "key": "x-api-key",
            "value": "{{tripSummaryApiKey}}",
            "type": "text"
          }
        ],
        "url": {
          "raw": "{{tripSummaryBaseUrl}}/trips?vehicleId={{testVin}}&include=summary&limit=5",
          "host": ["{{tripSummaryBaseUrl}}"],
          "path": ["trips"],
          "query": [
            {
              "key": "vehicleId",
              "value": "{{testVin}}"
            },
            {
              "key": "include",
              "value": "summary",
              "description": "Include full summary JSON (slower, more data)"
            },
            {
              "key": "limit",
              "value": "5"
            }
          ]
        },
        "description": "List trips with full summary JSON included (include=summary). More expensive than default."
      },
      "event": [
        {
          "listen": "test",
          "script": {
            "type": "text/javascript",
            "exec": [
              "pm.test('Status is 200', () => pm.response.to.have.status(200));",
              "",
              "pm.test('Items include summary field', () => {",
              "  const json = pm.response.json();",
              "  if (json.items && json.items.length > 0) {",
              "    pm.expect(json.items[0]).to.have.property('summary');",
              "  }",
              "});"
            ]
          }
        }
      ]
    },
    {
      "name": "List Trips - Time Range Filter",
      "request": {
        "method": "GET",
        "header": [
          {
            "key": "x-api-key",
            "value": "{{tripSummaryApiKey}}",
            "type": "text"
          }
        ],
        "url": {
          "raw": "{{tripSummaryBaseUrl}}/trips?vehicleId={{testVin}}&from=2026-01-01T00:00:00Z&to=2026-01-31T23:59:59Z",
          "host": ["{{tripSummaryBaseUrl}}"],
          "path": ["trips"],
          "query": [
            {
              "key": "vehicleId",
              "value": "{{testVin}}"
            },
            {
              "key": "from",
              "value": "2026-01-01T00:00:00Z",
              "description": "Start time (ISO8601)"
            },
            {
              "key": "to",
              "value": "2026-01-31T23:59:59Z",
              "description": "End time (ISO8601)"
            }
          ]
        },
        "description": "Filter trips by time range using from/to query params (ISO8601 format)."
      },
      "event": [
        {
          "listen": "test",
          "script": {
            "type": "text/javascript",
            "exec": [
              "pm.test('Status is 200', () => pm.response.to.have.status(200));"
            ]
          }
        }
      ]
    },
    {
      "name": "Get Trip Detail",
      "request": {
        "method": "GET",
        "header": [
          {
            "key": "x-api-key",
            "value": "{{tripSummaryApiKey}}",
            "type": "text"
          }
        ],
        "url": {
          "raw": "{{tripSummaryBaseUrl}}/trips/{{testVin}}/{{tripId}}",
          "host": ["{{tripSummaryBaseUrl}}"],
          "path": ["trips", "{{testVin}}", "{{tripId}}"],
          "query": [
            {
              "key": "include",
              "value": "summary",
              "description": "summary (default) or none",
              "disabled": true
            }
          ]
        },
        "description": "Get a single trip detail by VIN and tripId. Default includes summary JSON."
      },
      "event": [
        {
          "listen": "test",
          "script": {
            "type": "text/javascript",
            "exec": [
              "const is404 = pm.response.code === 404;",
              "const is200 = pm.response.code === 200;",
              "",
              "pm.test('Status is 200 or 404', () => {",
              "  pm.expect(is200 || is404).to.be.true;",
              "});",
              "",
              "if (is200) {",
              "  pm.test('Response has trip fields', () => {",
              "    const json = pm.response.json();",
              "    pm.expect(json).to.have.property('vin');",
              "    pm.expect(json).to.have.property('tripId');",
              "    pm.expect(json).to.have.property('summary');",
              "  });",
              "",
              "  pm.test('VIN matches path param', () => {",
              "    const json = pm.response.json();",
              "    pm.expect(json.vin).to.eql(pm.variables.get('testVin'));",
              "  });",
              "}",
              "",
              "if (is404) {",
              "  pm.test('404 response has error message', () => {",
              "    const json = pm.response.json();",
              "    pm.expect(json).to.have.property('error');",
              "  });",
              "}"
            ]
          }
        }
      ]
    },
    {
      "name": "Get Trip Detail - No Summary",
      "request": {
        "method": "GET",
        "header": [
          {
            "key": "x-api-key",
            "value": "{{tripSummaryApiKey}}",
            "type": "text"
          }
        ],
        "url": {
          "raw": "{{tripSummaryBaseUrl}}/trips/{{testVin}}/{{tripId}}?include=none",
          "host": ["{{tripSummaryBaseUrl}}"],
          "path": ["trips", "{{testVin}}", "{{tripId}}"],
          "query": [
            {
              "key": "include",
              "value": "none",
              "description": "Exclude summary JSON for faster response"
            }
          ]
        },
        "description": "Get trip detail without summary JSON (include=none) for faster response."
      },
      "event": [
        {
          "listen": "test",
          "script": {
            "type": "text/javascript",
            "exec": [
              "pm.test('Status is 200 or 404', () => {",
              "  pm.expect([200, 404]).to.include(pm.response.code);",
              "});",
              "",
              "if (pm.response.code === 200) {",
              "  pm.test('Response does NOT include summary', () => {",
              "    const json = pm.response.json();",
              "    pm.expect(json).to.not.have.property('summary');",
              "  });",
              "}"
            ]
          }
        }
      ]
    },
    {
      "name": "Pagination - First Page",
      "request": {
        "method": "GET",
        "header": [
          {
            "key": "x-api-key",
            "value": "{{tripSummaryApiKey}}",
            "type": "text"
          }
        ],
        "url": {
          "raw": "{{tripSummaryBaseUrl}}/trips?vehicleId={{testVin}}&limit=5",
          "host": ["{{tripSummaryBaseUrl}}"],
          "path": ["trips"],
          "query": [
            {
              "key": "vehicleId",
              "value": "{{testVin}}"
            },
            {
              "key": "limit",
              "value": "5",
              "description": "Small limit to trigger pagination"
            }
          ]
        },
        "description": "Get first page of results with small limit to test pagination."
      },
      "event": [
        {
          "listen": "test",
          "script": {
            "type": "text/javascript",
            "exec": [
              "pm.test('Status is 200', () => pm.response.to.have.status(200));",
              "",
              "const json = pm.response.json();",
              "",
              "pm.test('Has items array', () => {",
              "  pm.expect(json).to.have.property('items');",
              "});",
              "",
              "if (json.nextToken) {",
              "  pm.test('nextToken present (more pages available)', () => {",
              "    pm.expect(json.nextToken).to.be.a('string');",
              "    pm.environment.set('nextToken', json.nextToken);",
              "  });",
              "  console.log('Next page token saved to environment');",
              "} else {",
              "  console.log('No next page token - all results fit in one page');",
              "}"
            ]
          }
        }
      ]
    },
    {
      "name": "Pagination - Next Page",
      "request": {
        "method": "GET",
        "header": [
          {
            "key": "x-api-key",
            "value": "{{tripSummaryApiKey}}",
            "type": "text"
          }
        ],
        "url": {
          "raw": "{{tripSummaryBaseUrl}}/trips?vehicleId={{testVin}}&limit=5&nextToken={{nextToken}}",
          "host": ["{{tripSummaryBaseUrl}}"],
          "path": ["trips"],
          "query": [
            {
              "key": "vehicleId",
              "value": "{{testVin}}"
            },
            {
              "key": "limit",
              "value": "5"
            },
            {
              "key": "nextToken",
              "value": "{{nextToken}}",
              "description": "Token from previous response"
            }
          ]
        },
        "description": "Get next page using nextToken from previous response. Run 'Pagination - First Page' first."
      },
      "event": [
        {
          "listen": "test",
          "script": {
            "type": "text/javascript",
            "exec": [
              "pm.test('Status is 200', () => pm.response.to.have.status(200));",
              "",
              "pm.test('Has items array', () => {",
              "  const json = pm.response.json();",
              "  pm.expect(json).to.have.property('items');",
              "});"
            ]
          }
        }
      ]
    },
    {
      "name": "Error - Missing API Key",
      "request": {
        "method": "GET",
        "header": [],
        "url": {
          "raw": "{{tripSummaryBaseUrl}}/trips?vehicleId={{testVin}}",
          "host": ["{{tripSummaryBaseUrl}}"],
          "path": ["trips"],
          "query": [
            {
              "key": "vehicleId",
              "value": "{{testVin}}"
            }
          ]
        },
        "description": "Test that API Key is required - should return 403 Forbidden."
      },
      "event": [
        {
          "listen": "test",
          "script": {
            "type": "text/javascript",
            "exec": [
              "pm.test('Status is 403 Forbidden', () => {",
              "  pm.response.to.have.status(403);",
              "});",
              "",
              "pm.test('Error message mentions API key', () => {",
              "  const text = pm.response.text();",
              "  pm.expect(text.toLowerCase()).to.satisfy(t => ",
              "    t.includes('forbidden') || t.includes('api key') || t.includes('unauthorized')",
              "  );",
              "});"
            ]
          }
        }
      ]
    },
    {
      "name": "Error - Invalid VIN Format",
      "request": {
        "method": "GET",
        "header": [
          {
            "key": "x-api-key",
            "value": "{{tripSummaryApiKey}}",
            "type": "text"
          }
        ],
        "url": {
          "raw": "{{tripSummaryBaseUrl}}/trips?vehicleId=",
          "host": ["{{tripSummaryBaseUrl}}"],
          "path": ["trips"],
          "query": [
            {
              "key": "vehicleId",
              "value": "",
              "description": "Empty VIN should trigger 400"
            }
          ]
        },
        "description": "Test error handling for missing vehicleId or vehicleIds."
      },
      "event": [
        {
          "listen": "test",
          "script": {
            "type": "text/javascript",
            "exec": [
              "pm.test('Status is 400 Bad Request', () => {",
              "  pm.response.to.have.status(400);",
              "});",
              "",
              "pm.test('Error message present', () => {",
              "  const json = pm.response.json();",
              "  pm.expect(json).to.have.property('error');",
              "});"
            ]
          }
        }
      ]
    },
    {
      "name": "Get Trip Events (Normalized)",
      "request": {
        "method": "GET",
        "header": [
          {
            "key": "x-api-key",
            "value": "{{tripSummaryApiKey}}",
            "type": "text"
          },
          {
            "key": "x-tenant-id",
            "value": "{{tenantId}}",
            "type": "text"
          }
        ],
        "url": {
          "raw": "{{tripSummaryBaseUrl}}/trips/{{vin}}/{{tripId}}/events?limit={{limit}}",
          "host": ["{{tripSummaryBaseUrl}}"],
          "path": ["trips", "{{vin}}", "{{tripId}}", "events"],
          "query": [{ "key": "limit", "value": "{{limit}}" }]
        },
        "description": "Get telemetry events for a trip with normalized event payloads (14 key fields, no raw JSON). Optimized for map rendering and UI display. Returns ~500 bytes per event."
      },
      "event": [
        {
          "listen": "prerequest",
          "script": {
            "type": "text/javascript",
            "exec": [
              "// Append nextToken only when set",
              "const token = (pm.collectionVariables.get('nextToken') || pm.variables.get('nextToken') || '').trim();",
              "if (token) {",
              "  pm.request.url.addQueryParams({ nextToken: token });",
              "  console.log('Added nextToken to request:', token);",
              "} else {",
              "  console.log('No nextToken set; requesting first page');",
              "}"
            ]
          }
        },
        {
          "listen": "test",
          "script": {
            "type": "text/javascript",
            "exec": [
              "pm.test('Status is 200', () => { pm.response.to.have.status(200); });",
              "",
              "// Assert response is JSON",
              "let json = null;",
              "pm.test('Response is JSON', () => {",
              "  try { json = pm.response.json(); pm.expect(json).to.be.an('object'); }",
              "  catch (e) { pm.expect.fail('Response is not valid JSON'); }",
              "});",
              "",
              "// Shape checks",
              "pm.test('Body has tripId and vin', () => {",
              "  pm.expect(json).to.have.property('tripId');",
              "  pm.expect(json).to.have.property('vin');",
              "  pm.expect(json.tripId).to.eql(pm.variables.get('tripId'));",
              "  pm.expect(json.vin).to.eql(pm.variables.get('vin'));",
              "});",
              "pm.test('Count is a number', () => { pm.expect(json.count).to.satisfy(n => typeof n === 'number'); });",
              "pm.test('Items is an array', () => { pm.expect(json.items).to.be.an('array'); });",
              "",
              "if (Array.isArray(json.items) && json.items.length > 0) {",
              "  pm.test('Event items contain normalized fields', () => {",
              "    const requiredFields = ['timestamp', 'lat', 'lon', 'speed_mph', 'heading'];",
              "    json.items.forEach(it => {",
              "      requiredFields.forEach(field => {",
              "        pm.expect(it).to.have.property(field);",
              "      });",
              "      // Ensure raw field is NOT present in normalized response",
              "      pm.expect(it).to.not.have.property('raw');",
              "    });",
              "  });",
              "}",
              "",
              "// Save/clear nextToken at collection scope",
              "if (json.nextToken) {",
              "  pm.collectionVariables.set('nextToken', json.nextToken);",
              "  console.log('Saved nextToken to collection:', json.nextToken);",
              "} else {",
              "  pm.collectionVariables.set('nextToken', '');",
              "  console.log('Cleared nextToken (no more pages)');",
              "}"
            ]
          }
        }
      ]
    },
    {
      "name": "Get Trip Events (Raw)",
      "request": {
        "method": "GET",
        "header": [
          {
            "key": "x-api-key",
            "value": "{{tripSummaryApiKey}}",
            "type": "text"
          },
          {
            "key": "x-tenant-id",
            "value": "{{tenantId}}",
            "type": "text"
          }
        ],
        "url": {
          "raw": "{{tripSummaryBaseUrl}}/trips/{{vin}}/{{tripId}}/events/raw?limit={{limit}}",
          "host": ["{{tripSummaryBaseUrl}}"],
          "path": ["trips", "{{vin}}", "{{tripId}}", "events", "raw"],
          "query": [{ "key": "limit", "value": "{{limit}}" }]
        },
        "description": "Get complete telemetry events for a trip with full raw event payloads including device JSON. For debugging and detailed analysis. Returns ~5-10KB per event."
      },
      "event": [
        {
          "listen": "prerequest",
          "script": {
            "type": "text/javascript",
            "exec": [
              "// Append nextToken only when set",
              "const token = (pm.collectionVariables.get('nextTokenRaw') || pm.variables.get('nextTokenRaw') || '').trim();",
              "if (token) {",
              "  pm.request.url.addQueryParams({ nextToken: token });",
              "  console.log('Added nextToken to request:', token);",
              "} else {",
              "  console.log('No nextToken set; requesting first page');",
              "}"
            ]
          }
        },
        {
          "listen": "test",
          "script": {
            "type": "text/javascript",
            "exec": [
              "pm.test('Status is 200', () => { pm.response.to.have.status(200); });",
              "",
              "// Assert response is JSON",
              "let json = null;",
              "pm.test('Response is JSON', () => {",
              "  try { json = pm.response.json(); pm.expect(json).to.be.an('object'); }",
              "  catch (e) { pm.expect.fail('Response is not valid JSON'); }",
              "});",
              "",
              "// Shape checks",
              "pm.test('Body has tripId and vin', () => {",
              "  pm.expect(json).to.have.property('tripId');",
              "  pm.expect(json).to.have.property('vin');",
              "  pm.expect(json.tripId).to.eql(pm.variables.get('tripId'));",
              "  pm.expect(json.vin).to.eql(pm.variables.get('vin'));",
              "});",
              "pm.test('Count is a number', () => { pm.expect(json.count).to.satisfy(n => typeof n === 'number'); });",
              "pm.test('Items is an array', () => { pm.expect(json.items).to.be.an('array'); });",
              "",
              "if (Array.isArray(json.items) && json.items.length > 0) {",
              "  pm.test('Event items contain raw field with device JSON', () => {",
              "    json.items.forEach(it => {",
              "      pm.expect(it).to.have.property('raw');",
              "      pm.expect(it.raw).to.be.a('string');",
              "    });",
              "  });",
              "}",
              "",
              "// Save/clear nextToken at collection scope (separately from normalized events)",
              "if (json.nextToken) {",
              "  pm.collectionVariables.set('nextTokenRaw', json.nextToken);",
              "  console.log('Saved nextTokenRaw to collection:', json.nextToken);",
              "} else {",
              "  pm.collectionVariables.set('nextTokenRaw', '');",
              "  console.log('Cleared nextTokenRaw (no more pages)');",
              "}"
            ]
          }
        }
      ]
    },
    {
      "name": "Get Trip Map Data",
      "request": {
        "method": "GET",
        "header": [
          {
            "key": "x-api-key",
            "value": "{{tripSummaryApiKey}}",
            "type": "text"
          },
          {
            "key": "x-tenant-id",
            "value": "{{tenantId}}",
            "type": "text"
          }
        ],
        "url": {
          "raw": "{{tripSummaryBaseUrl}}/trips/{{vin}}/{{tripId}}/map",
          "host": ["{{tripSummaryBaseUrl}}"],
          "path": ["trips", "{{vin}}", "{{tripId}}", "map"]
        },
        "description": "Get pre-computed map data for a trip including sampled GPS path, road-snapped route, event markers, and bounds. Map data is generated when trip summary is created."
      },
      "event": [
        {
          "listen": "test",
          "script": {
            "type": "text/javascript",
            "exec": [
              "pm.test('Status is 200', () => { pm.response.to.have.status(200); });",
              "",
              "// Assert response is JSON",
              "let json = null;",
              "pm.test('Response is JSON', () => {",
              "  try { json = pm.response.json(); pm.expect(json).to.be.an('object'); }",
              "  catch (e) { pm.expect.fail('Response is not valid JSON'); }",
              "});",
              "",
              "// Shape checks",
              "pm.test('Body has tripId and vin', () => {",
              "  pm.expect(json).to.have.property('tripId');",
              "  pm.expect(json).to.have.property('vin');",
              "  pm.expect(json.tripId).to.eql(pm.variables.get('tripId'));",
              "  pm.expect(json.vin).to.eql(pm.variables.get('vin'));",
              "});",
              "",
              "pm.test('Map object exists', () => { pm.expect(json).to.have.property('map'); });",
              "",
              "if (json.map) {",
              "  pm.test('Map has required fields', () => {",
              "    pm.expect(json.map).to.have.property('sampledPath');",
              "    pm.expect(json.map).to.have.property('snappedPath');",
              "    pm.expect(json.map).to.have.property('startCoords');",
              "    pm.expect(json.map).to.have.property('endCoords');",
              "    pm.expect(json.map).to.have.property('bounds');",
              "    pm.expect(json.map).to.have.property('eventMarkers');",
              "    pm.expect(json.map).to.have.property('generatedAt');",
              "  });",
              "  ",
              "  pm.test('SampledPath is an array', () => {",
              "    pm.expect(json.map.sampledPath).to.be.an('array');",
              "  });",
              "  ",
              "  pm.test('EventMarkers is an array', () => {",
              "    pm.expect(json.map.eventMarkers).to.be.an('array');",
              "  });",
              "  ",
              "  if (json.map.sampledPath.length > 0) {",
              "    pm.test('SampledPath contains coordinate pairs', () => {",
              "      const firstPoint = json.map.sampledPath[0];",
              "      pm.expect(firstPoint).to.be.an('array').with.lengthOf(2);",
              "      pm.expect(firstPoint[0]).to.be.a('number'); // lat",
              "      pm.expect(firstPoint[1]).to.be.a('number'); // lon",
              "    });",
              "  }",
              "  ",
              "  if (json.map.bounds) {",
              "    pm.test('Bounds has valid coordinates', () => {",
              "      pm.expect(json.map.bounds).to.have.property('minLat');",
              "      pm.expect(json.map.bounds).to.have.property('maxLat');",
              "      pm.expect(json.map.bounds).to.have.property('minLon');",
              "      pm.expect(json.map.bounds).to.have.property('maxLon');",
              "    });",
              "  }",
              "}",
              "",
              "console.log('Map data retrieved:');",
              "if (json.map) {",
              "  console.log('- Sampled path points:', json.map.sampledPath?.length || 0);",
              "  console.log('- Snapped path points:', json.map.snappedPath?.length || 0);",
              "  console.log('- Event markers:', json.map.eventMarkers?.length || 0);",
              "  console.log('- Generated at:', json.map.generatedAt);",
              "}"
            ]
          }
        }
      ]
    },
    {
      "name": "Reset Pagination Token",
      "request": {
        "method": "GET",
        "header": [],
        "url": {
          "raw": "https://{{apiId}}.execute-api.{{region}}.amazonaws.com/{{stage}}/trips",
          "protocol": "https",
          "host": ["{{apiId}}.execute-api.{{region}}.amazonaws.com"],
          "path": ["{{stage}}", "trips"]
        },
        "description": "Helper: reset pagination token to start from first page in next request."
      },
      "event": [
        {
          "listen": "test",
          "script": {
            "type": "text/javascript",
            "exec": [
              "pm.collectionVariables.set('nextToken', '');",
              "pm.test('Pagination token reset', () => {",
              "  pm.expect(pm.collectionVariables.get('nextToken')).to.eql('');",
              "});"
            ]
          }
        }
      ]
    }
  ]
}
