AWSTemplateFormatVersion: "2010-09-09"
Description: onpoint lambdas, roles, permissions

Parameters:
  Env:
    Type: String
  ProjectName:
    Type: String
  LambdaRuntime:
    Type: String
    Default: python3.11
  LambdaMemory:
    Type: Number
    Default: 512
    MinValue: 128
    MaxValue: 10240
  LambdaTimeout:
    Type: Number
    Default: 30
  IngressHandler:
    Type: String
    Default: app.lambda_handler
  TelematicsProcessorHandler:
    Type: String
    Default: app.lambda_handler
  PslEnricherHandler:
    Type: String
    Default: app.lambda_handler
  OverspeedDetectorHandler:
    Type: String
    Default: app.lambda_handler
  TripSummaryBuilderHandler:
    Type: String
    Default: app.lambda_handler
  TripSummaryApiHandler:
    Type: String
    Default: app.lambda_handler
  FleetTenancyApiHandler:
    Type: String
    Default: app.lambda_handler
  VehicleStateApiHandler:
    Type: String
    Default: app.lambda_handler
  UserPoolId:
    Type: String
    Default: ""
  IngressCodeS3Bucket:
    Type: String
    Default: ""
  IngressCodeS3Key:
    Type: String
    Default: ""
  TelematicsProcessorCodeS3Bucket:
    Type: String
    Default: ""
  TelematicsProcessorCodeS3Key:
    Type: String
    Default: ""
  PslEnricherCodeS3Bucket:
    Type: String
    Default: ""
  PslEnricherCodeS3Key:
    Type: String
    Default: ""
  OverspeedDetectorCodeS3Bucket:
    Type: String
    Default: ""
  OverspeedDetectorCodeS3Key:
    Type: String
    Default: ""
  TripSummaryBuilderCodeS3Bucket:
    Type: String
    Default: ""
  TripSummaryBuilderCodeS3Key:
    Type: String
    Default: ""
  TripSummaryApiCodeS3Bucket:
    Type: String
    Default: ""
  TripSummaryApiCodeS3Key:
    Type: String
    Default: ""
  VehicleStateApiCodeS3Bucket:
    Type: String
    Default: ""
  VehicleStateApiCodeS3Key:
    Type: String
    Default: ""
  FleetTenancyApiCodeS3Bucket:
    Type: String
    Default: ""
  FleetTenancyApiCodeS3Key:
    Type: String
    Default: ""
  CommonLayerS3Bucket:
    Type: String
    Default: ""
  CommonLayerS3Key:
    Type: String
    Default: ""
  TelematicsStreamName:
    Type: String
  TelematicsStreamArn:
    Type: String
  IngressQueueArn:
    Type: String
  PslEnrichQueueUrl:
    Type: String
  PslEnrichQueueArn:
    Type: String
  TripSummaryQueueUrl:
    Type: String
  TripSummaryQueueArn:
    Type: String
  TelemetryEventsTableName:
    Type: String
  VinRegistryTableName:
    Type: String
  TenantsTableName:
    Type: String
  CustomersTableName:
    Type: String
  FleetsTableName:
    Type: String
  VehiclesTableName:
    Type: String
  DriversTableName:
    Type: String
  DriverAssignmentsTableName:
    Type: String
  AuditLogTableName:
    Type: String
  IdempotencyTableName:
    Type: String
  VehicleStateTableName:
    Type: String
  TripsTableName:
    Type: String
  TripSummaryTableName:
    Type: String
  PslCacheTableName:
    Type: String
  OverspeedDedupeTableName:
    Type: String
  DefaultDomain:
    Type: String
    Default: telematics
  ExpectedSchemaVersion:
    Type: String
    Default: telematics-1.0
  NormalizedSchemaVersion:
    Type: String
    Default: normalized-telematics-1.0
  PslJobSchemaVersion:
    Type: String
    Default: psl-job-1.0
  IngressMaxRawPayloadBytes:
    Type: String
    Default: "262144"
  ProviderLookupMode:
    Type: String
    Default: dynamodb
  ProviderKeysTableName:
    Type: String
    Default: onpoint-dev-provider-keys
  ProviderKeysParam:
    Type: String
    Default: /onpoint/dev/providerKeys
  EventBusName:
    Type: String
    Default: default
  EventSource:
    Type: String
    Default: onpoint.overspeed
  EventDetailType:
    Type: String
    Default: OverspeedAlert
  OverspeedStandardThresholdMph:
    Type: String
    Default: "5"
  OverspeedSevereThresholdMph:
    Type: String
    Default: "15"
  OverspeedCooldownSeconds:
    Type: String
    Default: "60"
  MinPslConfidence:
    Type: String
    Default: LOW
  SkipAlertsBelowMinConf:
    Type: String
    Default: "true"
  DedupeTtlSeconds:
    Type: String
    Default: ""
  OverpassEndpoints:
    Type: String
    Default: https://overpass-api.de/api/interpreter,https://overpass.kumi.systems/api/interpreter
  OverpassTimeoutSeconds:
    Type: String
    Default: "10"
  OverpassMaxRetries:
    Type: String
    Default: "1"
  OverspeedThresholdMph:
    Type: String
    Default: "5"
  SevereThresholdMph:
    Type: String
    Default: "15"
  CooldownSeconds:
    Type: String
    Default: "60"
  CacheTtlDays:
    Type: String
    Default: "14"
  NullCacheTtlHours:
    Type: String
    Default: "12"
  TripSummarySchemaVersion:
    Type: String
    Default: trip-summary-1.0
  RefuelNoiseThresholdGal:
    Type: String
    Default: "0.25"
  SpeedThresholdMph:
    Type: String
    Default: "5"
  DefaultLimit:
    Type: String
    Default: "50"
  MaxLimit:
    Type: String
    Default: "200"
  PageSize:
    Type: String
    Default: "100"
  MaxPagesPerVin:
    Type: String
    Default: "3"
  EnableTenantFleetIndex:
    Type: String
    Default: "false"

Conditions:
  HasIngressCode: !And [!Not [!Equals [!Ref IngressCodeS3Bucket, ""]], !Not [!Equals [!Ref IngressCodeS3Key, ""]]]
  HasTelematicsProcessorCode: !And [!Not [!Equals [!Ref TelematicsProcessorCodeS3Bucket, ""]], !Not [!Equals [!Ref TelematicsProcessorCodeS3Key, ""]]]
  HasPslEnricherCode: !And [!Not [!Equals [!Ref PslEnricherCodeS3Bucket, ""]], !Not [!Equals [!Ref PslEnricherCodeS3Key, ""]]]
  HasOverspeedDetectorCode: !And [!Not [!Equals [!Ref OverspeedDetectorCodeS3Bucket, ""]], !Not [!Equals [!Ref OverspeedDetectorCodeS3Key, ""]]]
  HasTripSummaryBuilderCode: !And [!Not [!Equals [!Ref TripSummaryBuilderCodeS3Bucket, ""]], !Not [!Equals [!Ref TripSummaryBuilderCodeS3Key, ""]]]
  HasTripSummaryApiCode: !And [!Not [!Equals [!Ref TripSummaryApiCodeS3Bucket, ""]], !Not [!Equals [!Ref TripSummaryApiCodeS3Key, ""]]]
  HasVehicleStateApiCode: !And [!Not [!Equals [!Ref VehicleStateApiCodeS3Bucket, ""]], !Not [!Equals [!Ref VehicleStateApiCodeS3Key, ""]]]
  HasFleetTenancyApiCode: !And [!Not [!Equals [!Ref FleetTenancyApiCodeS3Bucket, ""]], !Not [!Equals [!Ref FleetTenancyApiCodeS3Key, ""]]]
  HasCommonLayer: !And [!Not [!Equals [!Ref CommonLayerS3Bucket, ""]], !Not [!Equals [!Ref CommonLayerS3Key, ""]]]
  EnableTenantFleetIndexCondition: !Equals [!Ref EnableTenantFleetIndex, "true"]
  HasUserPoolId: !Not [!Equals [!Ref UserPoolId, ""]]

Resources:
  CommonLayerVersion:
    Type: AWS::Lambda::LayerVersion
    Condition: HasCommonLayer
    Properties:
      LayerName: !Sub "${ProjectName}-${Env}-common-layer"
      Description: "onpoint_common module shared across Lambda functions"
      Content:
        S3Bucket: !Ref CommonLayerS3Bucket
        S3Key: !Ref CommonLayerS3Key
      CompatibleRuntimes:
        - python3.11
        - python3.12

  LambdaRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub "${ProjectName}-${Env}-lambda-role"
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
      Policies:
        - PolicyName: !Sub "${ProjectName}-${Env}-lambda-access"
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - dynamodb:*
                Resource:
                  - !Sub arn:aws:dynamodb:${AWS::Region}:${AWS::AccountId}:table/${TelemetryEventsTableName}
                  - !Sub arn:aws:dynamodb:${AWS::Region}:${AWS::AccountId}:table/${TelemetryEventsTableName}/*
                  - !Sub arn:aws:dynamodb:${AWS::Region}:${AWS::AccountId}:table/${VinRegistryTableName}
                  - !Sub arn:aws:dynamodb:${AWS::Region}:${AWS::AccountId}:table/${VinRegistryTableName}/*
                  - !Sub arn:aws:dynamodb:${AWS::Region}:${AWS::AccountId}:table/${TenantsTableName}
                  - !Sub arn:aws:dynamodb:${AWS::Region}:${AWS::AccountId}:table/${TenantsTableName}/*
                  - !Sub arn:aws:dynamodb:${AWS::Region}:${AWS::AccountId}:table/${CustomersTableName}
                  - !Sub arn:aws:dynamodb:${AWS::Region}:${AWS::AccountId}:table/${CustomersTableName}/*
                  - !Sub arn:aws:dynamodb:${AWS::Region}:${AWS::AccountId}:table/${FleetsTableName}
                  - !Sub arn:aws:dynamodb:${AWS::Region}:${AWS::AccountId}:table/${FleetsTableName}/*
                  - !Sub arn:aws:dynamodb:${AWS::Region}:${AWS::AccountId}:table/${VehiclesTableName}
                  - !Sub arn:aws:dynamodb:${AWS::Region}:${AWS::AccountId}:table/${VehiclesTableName}/*
                  - !Sub arn:aws:dynamodb:${AWS::Region}:${AWS::AccountId}:table/${DriversTableName}
                  - !Sub arn:aws:dynamodb:${AWS::Region}:${AWS::AccountId}:table/${DriversTableName}/*
                  - !Sub arn:aws:dynamodb:${AWS::Region}:${AWS::AccountId}:table/${DriverAssignmentsTableName}
                  - !Sub arn:aws:dynamodb:${AWS::Region}:${AWS::AccountId}:table/${DriverAssignmentsTableName}/*
                  - !Sub arn:aws:dynamodb:${AWS::Region}:${AWS::AccountId}:table/${AuditLogTableName}
                  - !Sub arn:aws:dynamodb:${AWS::Region}:${AWS::AccountId}:table/${AuditLogTableName}/*
                  - !Sub arn:aws:dynamodb:${AWS::Region}:${AWS::AccountId}:table/${IdempotencyTableName}
                  - !Sub arn:aws:dynamodb:${AWS::Region}:${AWS::AccountId}:table/${IdempotencyTableName}/*
                  - !Sub arn:aws:dynamodb:${AWS::Region}:${AWS::AccountId}:table/${VehicleStateTableName}
                  - !Sub arn:aws:dynamodb:${AWS::Region}:${AWS::AccountId}:table/${VehicleStateTableName}/*
                  - !Sub arn:aws:dynamodb:${AWS::Region}:${AWS::AccountId}:table/${TripsTableName}
                  - !Sub arn:aws:dynamodb:${AWS::Region}:${AWS::AccountId}:table/${TripsTableName}/*
                  - !Sub arn:aws:dynamodb:${AWS::Region}:${AWS::AccountId}:table/${TripSummaryTableName}
                  - !Sub arn:aws:dynamodb:${AWS::Region}:${AWS::AccountId}:table/${TripSummaryTableName}/*
                  - !Sub arn:aws:dynamodb:${AWS::Region}:${AWS::AccountId}:table/${PslCacheTableName}
                  - !Sub arn:aws:dynamodb:${AWS::Region}:${AWS::AccountId}:table/${PslCacheTableName}/*
                  - !Sub arn:aws:dynamodb:${AWS::Region}:${AWS::AccountId}:table/${OverspeedDedupeTableName}
                  - !Sub arn:aws:dynamodb:${AWS::Region}:${AWS::AccountId}:table/${OverspeedDedupeTableName}/*
                  - !Sub arn:aws:dynamodb:${AWS::Region}:${AWS::AccountId}:table/${ProviderKeysTableName}
                  - !Sub arn:aws:dynamodb:${AWS::Region}:${AWS::AccountId}:table/${ProviderKeysTableName}/*
              - Effect: Allow
                Action:
                  - ssm:GetParameter
                Resource:
                  - !Sub arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter${ProviderKeysParam}
              - !If
                - HasUserPoolId
                - Effect: Allow
                  Action:
                    - cognito-idp:AdminCreateUser
                    - cognito-idp:AdminAddUserToGroup
                    - cognito-idp:AdminGetUser
                    - cognito-idp:AdminListGroupsForUser
                    - cognito-idp:AdminRemoveUserFromGroup
                    - cognito-idp:AdminUpdateUserAttributes
                    - cognito-idp:AdminDisableUser
                    - cognito-idp:AdminEnableUser
                    - cognito-idp:ListUsers
                  Resource: !Sub arn:aws:cognito-idp:${AWS::Region}:${AWS::AccountId}:userpool/${UserPoolId}
                - !Ref AWS::NoValue
              - Effect: Allow
                Action:
                  - sqs:ReceiveMessage
                  - sqs:DeleteMessage
                  - sqs:GetQueueAttributes
                  - sqs:ChangeMessageVisibility
                Resource:
                  - !Ref IngressQueueArn
                  - !Ref PslEnrichQueueArn
                  - !Ref TripSummaryQueueArn
              - Effect: Allow
                Action:
                  - sqs:SendMessage
                Resource:
                  - !Ref PslEnrichQueueArn
                  - !Ref TripSummaryQueueArn
              - Effect: Allow
                Action:
                  - kinesis:PutRecord
                  - kinesis:PutRecords
                  - kinesis:DescribeStream
                  - kinesis:GetRecords
                  - kinesis:GetShardIterator
                  - kinesis:ListShards
                Resource: !Ref TelematicsStreamArn
              - Effect: Allow
                Action:
                  - events:PutEvents
                Resource: !Sub arn:aws:events:${AWS::Region}:${AWS::AccountId}:event-bus/${EventBusName}

  IngressFunction:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Sub "${ProjectName}-${Env}-ingress"
      Role: !GetAtt LambdaRole.Arn
      Runtime: !Ref LambdaRuntime
      Handler: !Ref IngressHandler
      MemorySize: !Ref LambdaMemory
      Timeout: !Ref LambdaTimeout
      Environment:
        Variables:
          ENV: !Ref Env
          PROJECT: !Ref ProjectName
          INGRESS_STREAM_NAME: !Ref TelematicsStreamName
          MAX_RAW_PAYLOAD_BYTES: !Ref IngressMaxRawPayloadBytes
          PROVIDER_LOOKUP_MODE: !Ref ProviderLookupMode
          PROVIDER_TABLE: !Ref ProviderKeysTableName
          PROVIDER_KEYS_PARAM: !Ref ProviderKeysParam
      Code:
        S3Bucket: !If [HasIngressCode, !Ref IngressCodeS3Bucket, !Ref AWS::NoValue]
        S3Key: !If [HasIngressCode, !Ref IngressCodeS3Key, !Ref AWS::NoValue]
      Layers:
        - !If [HasCommonLayer, !Ref CommonLayerVersion, !Ref AWS::NoValue]

  TelematicsProcessorFunction:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Sub "${ProjectName}-${Env}-telematics-processor"
      Role: !GetAtt LambdaRole.Arn
      Runtime: !Ref LambdaRuntime
      Handler: !Ref TelematicsProcessorHandler
      MemorySize: !Ref LambdaMemory
      Timeout: !Ref LambdaTimeout
      Environment:
        Variables:
          PROJECT_NAME: !Ref ProjectName
          ENVIRONMENT: !Ref Env
          DEFAULT_DOMAIN: !Ref DefaultDomain
          TELEMETRY_EVENTS_TABLE: !Ref TelemetryEventsTableName
          VIN_REGISTRY_TABLE: !Ref VinRegistryTableName
          VEHICLE_STATE_TABLE: !Ref VehicleStateTableName
          TRIPS_TABLE: !Ref TripsTableName
          TRIP_SUMMARY_QUEUE_URL: !Ref TripSummaryQueueUrl
          PSL_ENRICH_QUEUE_URL: !Ref PslEnrichQueueUrl
          PSL_JOB_SCHEMA_VERSION: !Ref PslJobSchemaVersion
          EXPECTED_SCHEMA_VERSION: !Ref ExpectedSchemaVersion
          NORMALIZED_SCHEMA_VERSION: !Ref NormalizedSchemaVersion
      Code:
        S3Bucket: !If [HasTelematicsProcessorCode, !Ref TelematicsProcessorCodeS3Bucket, !Ref AWS::NoValue]
        S3Key: !If [HasTelematicsProcessorCode, !Ref TelematicsProcessorCodeS3Key, !Ref AWS::NoValue]
      Layers:
        - !If [HasCommonLayer, !Ref CommonLayerVersion, !Ref AWS::NoValue]

  PslEnricherFunction:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Sub "${ProjectName}-${Env}-psl-enricher"
      Role: !GetAtt LambdaRole.Arn
      Runtime: !Ref LambdaRuntime
      Handler: !Ref PslEnricherHandler
      MemorySize: !Ref LambdaMemory
      Timeout: !Ref LambdaTimeout
      Environment:
        Variables:
          TELEMETRY_EVENTS_TABLE: !Ref TelemetryEventsTableName
          PSL_CACHE_TABLE: !Ref PslCacheTableName
          OVERSPEED_DEDUPE_TABLE: !Ref OverspeedDedupeTableName
          OVERPASS_ENDPOINTS: !Ref OverpassEndpoints
          OVERPASS_TIMEOUT_SECONDS: !Ref OverpassTimeoutSeconds
          OVERPASS_MAX_RETRIES: !Ref OverpassMaxRetries
          OVERSPEED_THRESHOLD_MPH: !Ref OverspeedThresholdMph
          SEVERE_THRESHOLD_MPH: !Ref SevereThresholdMph
          COOLDOWN_SECONDS: !Ref CooldownSeconds
          CACHE_TTL_DAYS: !Ref CacheTtlDays
          NULL_CACHE_TTL_HOURS: !Ref NullCacheTtlHours
      Code:
        S3Bucket: !If [HasPslEnricherCode, !Ref PslEnricherCodeS3Bucket, !Ref AWS::NoValue]
        S3Key: !If [HasPslEnricherCode, !Ref PslEnricherCodeS3Key, !Ref AWS::NoValue]

  OverspeedDetectorFunction:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Sub "${ProjectName}-${Env}-overspeed-detector"
      Role: !GetAtt LambdaRole.Arn
      Runtime: !Ref LambdaRuntime
      Handler: !Ref OverspeedDetectorHandler
      MemorySize: !Ref LambdaMemory
      Timeout: !Ref LambdaTimeout
      Environment:
        Variables:
          TELEMETRY_EVENTS_TABLE: !Ref TelemetryEventsTableName
          VEHICLE_STATE_TABLE: !Ref VehicleStateTableName
          OVERSPEED_DEDUPE_TABLE: !Ref OverspeedDedupeTableName
          EVENT_BUS_NAME: !Ref EventBusName
          EVENT_SOURCE: !Ref EventSource
          EVENT_DETAIL_TYPE: !Ref EventDetailType
          OVERSPEED_STANDARD_THRESHOLD_MPH: !Ref OverspeedStandardThresholdMph
          OVERSPEED_SEVERE_THRESHOLD_MPH: !Ref OverspeedSevereThresholdMph
          OVERSPEED_COOLDOWN_SECONDS: !Ref OverspeedCooldownSeconds
          MIN_PSL_CONFIDENCE: !Ref MinPslConfidence
          SKIP_ALERTS_BELOW_MIN_CONF: !Ref SkipAlertsBelowMinConf
          DEDUPE_TTL_SECONDS: !Ref DedupeTtlSeconds
      Code:
        S3Bucket: !If [HasOverspeedDetectorCode, !Ref OverspeedDetectorCodeS3Bucket, !Ref AWS::NoValue]
        S3Key: !If [HasOverspeedDetectorCode, !Ref OverspeedDetectorCodeS3Key, !Ref AWS::NoValue]

  TripSummaryBuilderFunction:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Sub "${ProjectName}-${Env}-trip-summary-builder"
      Role: !GetAtt LambdaRole.Arn
      Runtime: !Ref LambdaRuntime
      Handler: !Ref TripSummaryBuilderHandler
      MemorySize: !Ref LambdaMemory
      Timeout: !Ref LambdaTimeout
      Environment:
        Variables:
          TELEMETRY_EVENTS_TABLE: !Ref TelemetryEventsTableName
          TRIP_SUMMARY_TABLE: !Ref TripSummaryTableName
          TRIP_SUMMARY_SCHEMA_VERSION: !Ref TripSummarySchemaVersion
          REFUEL_NOISE_THRESHOLD_GAL: !Ref RefuelNoiseThresholdGal
          SPEED_THRESHOLD_MPH: !Ref SpeedThresholdMph
      Code:
        S3Bucket: !If [HasTripSummaryBuilderCode, !Ref TripSummaryBuilderCodeS3Bucket, !Ref AWS::NoValue]
        S3Key: !If [HasTripSummaryBuilderCode, !Ref TripSummaryBuilderCodeS3Key, !Ref AWS::NoValue]

  TripSummaryApiFunction:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Sub "${ProjectName}-${Env}-trip-summary-api"
      Role: !GetAtt LambdaRole.Arn
      Runtime: !Ref LambdaRuntime
      Handler: !Ref TripSummaryApiHandler
      MemorySize: !Ref LambdaMemory
      Timeout: !Ref LambdaTimeout
      Environment:
        Variables:
          TRIP_SUMMARY_TABLE: !Ref TripSummaryTableName
          TELEMETRY_EVENTS_TABLE: !Ref TelemetryEventsTableName
          VIN_REGISTRY_TABLE: !Ref VinRegistryTableName
          VIN_TENANT_FLEET_INDEX: !If [EnableTenantFleetIndexCondition, TenantFleetIndexV2, !Ref AWS::NoValue]
          DEFAULT_LIMIT: !Ref DefaultLimit
          MAX_LIMIT: !Ref MaxLimit
          PAGE_SIZE: !Ref PageSize
          MAX_PAGES_PER_VIN: !Ref MaxPagesPerVin
      Code:
        S3Bucket: !If [HasTripSummaryApiCode, !Ref TripSummaryApiCodeS3Bucket, !Ref AWS::NoValue]
        S3Key: !If [HasTripSummaryApiCode, !Ref TripSummaryApiCodeS3Key, !Ref AWS::NoValue]
      Layers:
        - !If [HasCommonLayer, !Ref CommonLayerVersion, !Ref AWS::NoValue]

  VehicleStateApiFunction:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Sub "${ProjectName}-${Env}-vehicle-state-api"
      Role: !GetAtt LambdaRole.Arn
      Runtime: !Ref LambdaRuntime
      Handler: !Ref VehicleStateApiHandler
      MemorySize: !Ref LambdaMemory
      Timeout: !Ref LambdaTimeout
      Environment:
        Variables:
          VEHICLE_STATE_TABLE: !Ref VehicleStateTableName
          VIN_REGISTRY_TABLE: !Ref VinRegistryTableName
          VIN_TENANT_FLEET_INDEX: !If [EnableTenantFleetIndexCondition, TenantFleetIndexV2, !Ref AWS::NoValue]
      Code:
        S3Bucket: !If [HasVehicleStateApiCode, !Ref VehicleStateApiCodeS3Bucket, !Ref AWS::NoValue]
        S3Key: !If [HasVehicleStateApiCode, !Ref VehicleStateApiCodeS3Key, !Ref AWS::NoValue]
      Layers:
        - !If [HasCommonLayer, !Ref CommonLayerVersion, !Ref AWS::NoValue]

  FleetTenancyApiFunction:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Sub "${ProjectName}-${Env}-fleet-tenancy-api"
      Role: !GetAtt LambdaRole.Arn
      Runtime: !Ref LambdaRuntime
      Handler: !Ref FleetTenancyApiHandler
      MemorySize: !Ref LambdaMemory
      Timeout: !Ref LambdaTimeout
      Environment:
        Variables:
          TENANTS_TABLE: !Ref TenantsTableName
          CUSTOMERS_TABLE: !Ref CustomersTableName
          FLEETS_TABLE: !Ref FleetsTableName
          VEHICLES_TABLE: !Ref VehiclesTableName
          VIN_REGISTRY_TABLE: !Ref VinRegistryTableName
          DRIVERS_TABLE: !Ref DriversTableName
          DRIVER_ASSIGNMENTS_TABLE: !Ref DriverAssignmentsTableName
          AUDIT_LOG_TABLE: !Ref AuditLogTableName
          IDEMPOTENCY_TABLE: !Ref IdempotencyTableName
          VIN_TENANT_INDEX: TenantIndex
          VIN_TENANT_FLEET_INDEX: !If [EnableTenantFleetIndexCondition, TenantFleetIndexV2, !Ref AWS::NoValue]
          USER_POOL_ID: !If [HasUserPoolId, !Ref UserPoolId, !Ref AWS::NoValue]
      Code:
        S3Bucket: !If [HasFleetTenancyApiCode, !Ref FleetTenancyApiCodeS3Bucket, !Ref AWS::NoValue]
        S3Key: !If [HasFleetTenancyApiCode, !Ref FleetTenancyApiCodeS3Key, !Ref AWS::NoValue]
      Layers:
        - !If [HasCommonLayer, !Ref CommonLayerVersion, !Ref AWS::NoValue]

  IngressEventSourceMapping:
    Type: AWS::Lambda::EventSourceMapping
    Properties:
      EventSourceArn: !Ref IngressQueueArn
      FunctionName: !Ref IngressFunction
      BatchSize: 10
      Enabled: true

  PslEnricherEventSourceMapping:
    Type: AWS::Lambda::EventSourceMapping
    Properties:
      EventSourceArn: !Ref PslEnrichQueueArn
      FunctionName: !Ref PslEnricherFunction
      BatchSize: 10
      Enabled: true

  TripSummaryBuilderEventSourceMapping:
    Type: AWS::Lambda::EventSourceMapping
    Properties:
      EventSourceArn: !Ref TripSummaryQueueArn
      FunctionName: !Ref TripSummaryBuilderFunction
      BatchSize: 10
      Enabled: true

  TelematicsProcessorEventSourceMapping:
    Type: AWS::Lambda::EventSourceMapping
    Properties:
      EventSourceArn: !Ref TelematicsStreamArn
      FunctionName: !Ref TelematicsProcessorFunction
      StartingPosition: LATEST
      BatchSize: 100
      Enabled: true

Outputs:
  IngressFunctionName:
    Value: !Ref IngressFunction
  TelematicsProcessorFunctionName:
    Value: !Ref TelematicsProcessorFunction
  PslEnricherFunctionName:
    Value: !Ref PslEnricherFunction
  OverspeedDetectorFunctionName:
    Value: !Ref OverspeedDetectorFunction
  TripSummaryBuilderFunctionName:
    Value: !Ref TripSummaryBuilderFunction
  TripSummaryApiFunctionName:
    Value: !Ref TripSummaryApiFunction
  TripSummaryApiFunctionArn:
    Value: !GetAtt TripSummaryApiFunction.Arn
  FleetTenancyApiFunctionName:
    Value: !Ref FleetTenancyApiFunction
  FleetTenancyApiFunctionArn:
    Value: !GetAtt FleetTenancyApiFunction.Arn
  VehicleStateApiFunctionName:
    Value: !Ref VehicleStateApiFunction
  VehicleStateApiFunctionArn:
    Value: !GetAtt VehicleStateApiFunction.Arn
  LambdaRoleArn:
    Value: !GetAtt LambdaRole.Arn
