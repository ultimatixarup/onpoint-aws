<ngx-spinner bdColor="rgba(0,0,0,0.8)" size="large" color="#fff" type="ball-elastic-dots" [fullScreen]="true">
  <div class="custom-spinner">
    <img src="../../../../../assets/images/spinner3.svg" alt="Your Logo">
  </div>
  <div class="loading-text">Please wait, we are getting information...</div>
</ngx-spinner>
<div class="page-content page-content-main">
  <div class="row left-navigation">
    <div class="col-xs-12 col-lg-2 navbar-side-menu">
      <app-sidebar></app-sidebar>
    </div>
  <!--Side bar Menu End-->
  <!-- Main Content Right-->
  <div class="col-xs-12 col-lg-12" style="margin-left: 1%; width: 100%;">
    <!-- Heading and Breadcrumb -->
      <!-- Heading and Breadcrumb -->
      <div class="row">
        <div class="col-xs-12 col-lg-12">
          <span class="breadcrumb-left">
            <h1 class="login-headline heading-title">{{ mode === 'add' ? 'Add Driver' : 'Edit Driver' }}
            </h1>
          </span>
          <span class="breadcrumb-right mr-8">
            <ol class="breadcrumb">
              <ng-container *ngIf="user =='admin'">
                <li class="breadcrumb-item">
                  <a routerLink="/adlp/admin" class="breadcrumb-h6"><i class="bx bx-home-circle"></i></a>
                </li>
                <li class="breadcrumb-item inactive-bread"><a routerLink="/adlp/admin/dashboardAdmin">Dashboard</a></li>
                <li class="breadcrumb-item inactive-bread"><a
                    routerLink="/adlp/admin/admindashboard/manageDriver/dashboardDriver">Manage Driver</a></li>
                <li class="breadcrumb-item text-selected active-bread">{{ mode === 'add' ? 'Add Driver' : 'Edit Driver' }}</li>
              </ng-container>
              <ng-container *ngIf="user !='admin'">
                <li class="breadcrumb-item">
                  <a routerLink="/adlp/admin/admindashboard/dashboardfleet" class="breadcrumb-h6"><i
                      class="bx bx-home-circle"></i></a>
                </li>
                <li class="breadcrumb-item inactive-bread"><a
                    routerLink="/adlp/admin/admindashboard/dashboardfleet">Dashboard</a></li>
                <li class="breadcrumb-item text-selected active-bread">Manage Driver</li>
              </ng-container>
            </ol>
          </span>
        </div>
      </div>
      <!-- Heading and Breadcrumb End-->
      <div class="row consumer-pad">
        <div class="col-xs-12 col-lg-2 mr6">
          <ng-container *ngIf="this.user === 'admin'">
            <select class="form-select consumer-select no-border" [(ngModel)]="consumer" (change)="selectConsumer()">
              <option value="" disabled hidden>Select Consumer</option>
              <option value="All">Consumer</option>
              <option *ngFor="let consumer of consumerList" [ngValue]="consumer">
                {{ consumer.name }}
              </option>
            </select>
          </ng-container>
        </div>
        <div class="col-xs-12 col-lg-8">&nbsp;</div>
        <div class="col-xs-12 col-lg-2 mr6">
          <!-- <ng-select [searchable]="true" class="newSelect1" [clearable]="true" placeholder="Organization Id/Name" [(ngModel)]="fleetIdData">
            <ng-option *ngFor="let fleet of fleetList" value="{{ fleet.id }}">{{ fleet.id }} - [{{ fleet.name
              }}]</ng-option>
          </ng-select> -->
        </div>
      </div>
      <!--Add single and bulk driver-->
      <div class="row">
        <div class="col-xs-12 col-lg-3">&nbsp;</div>
        <div class="col-xs-12 col-lg-6">
          <div class="row">
            <div class="col-xs-12 col-lg-12">
              <div class="card">
                <div class="card-body">
                  <div class="row align-items-center justify-content-center mr-20">
                    <div class="col-xs-12 col-lg-4 text-center">
                      <button class="btn-driver" (click)="selectButton('single')"
                        [ngClass]="{'selected': selectedButton === 'single'}">
                        {{ mode === 'add' ? 'Add Driver' : 'Edit Driver' }}
                      </button>
                    </div>
                    <!-- <div class="col-xs-12 col-lg-4 text-center">
                      <button class="btn-driver" (click)="selectButton('association')"
                        [ngClass]="{'selected': selectedButton === 'association'}">
                        {{ mode === 'add' ? 'Association' : 'Association' }}

                      </button>
                    </div>
                    <div class="col-xs-12 col-lg-4 text-center" *ngIf="mode === 'edit'">
                      <button class="btn-driver" (click)="selectButton('dissociation')"
                        [ngClass]="{'selected': selectedButton === 'dissociation'}">
                         Dissociation

                      </button>
                    </div> -->
                    <div class="col-xs-12 col-lg-4 text-center" *ngIf="mode === 'add'">
                      <button class="btn-driver" (click)="selectButton('multiple')"
                        [ngClass]="{'selected': selectedButton === 'multiple'}">
                       Add Multiple Driver
                      </button>
                    </div>
                  </div>
                  <!-- Single Driver Add-->
                  <ng-container *ngIf="selectedButton === 'single'">
                    <form #driverForm="ngForm" (ngSubmit)="submitDriver()" novalidate>
                      <div class="row he85 mr20">
                        <!-- Driver First Name -->
                        <div class="col-xs-12 col-lg-6">
                          <label for="firstName" class="form-label">First Name&nbsp;<span class="text-danger">*</span></label>
                          <input
                            type="text"
                            class="form-input select-data"
                            id="firstName"
                            placeholder="Driver First Name"
                            [(ngModel)]="driverData.firstName"
                            name="firstName"
                            #firstName="ngModel"
                            required
                            autocomplete="off" />
                          <div *ngIf="firstName.invalid && firstName.touched" class="error">
                            First name is required.
                          </div>
                        </div>

                        <!-- Driver Last Name -->
                        <div class="col-xs-12 col-lg-6">
                          <label for="firstName" class="form-label">Last Name&nbsp;<span class="text-danger">*</span></label>
                          <input
                            type="text"
                            class="form-input select-data"
                            id="lastName"
                            placeholder="Driver Last Name"
                            [(ngModel)]="driverData.lastName"
                            name="lastName"
                            #lastName="ngModel"
                            required
                            autocomplete="off" />
                          <div *ngIf="lastName.invalid && lastName.touched" class="error">
                            Last name is required.
                          </div>
                        </div>
                      </div>

                      <div class="row he85">
                        <!-- Email -->
                        <div class="col-xs-12 col-lg-12">
                          <label for="firstName" class="form-label">Email&nbsp;<span class="text-danger">*</span></label>
                          <input
                            type="email"
                            class="form-input select-data"
                            id="email"
                            placeholder="Enter Email Id"
                            [(ngModel)]="driverData.email"
                            name="email"
                            #email="ngModel"
                            required
                            email
                            autocomplete="off" />
                          <div *ngIf="email.invalid && email.touched" class="error">
                            <div *ngIf="email.errors?.required">Email is required.</div>
                            <div *ngIf="email.errors?.email">Invalid Email Format.</div>
                          </div>
                        </div>
                      </div>

                      <div class="row he85">
                        <!-- Phone Number -->
                        <div class="col-xs-12 col-lg-12">
                          <label for="firstName" class="form-label">Contact Number&nbsp;<span class="text-danger">*</span></label>
                          <input
                            type="text"
                            class="form-input select-data"
                            id="phoneNo"
                            name="phoneNo"
                            placeholder="Contact Number"
                            [(ngModel)]="driverData.phoneNo"
                            #phoneNo="ngModel"

                            autocomplete="off"
                            title="Phone number must be in a valid format: (123) 456-7890 or 123-456-7890"
                            (input)="onPhoneNumberChange($event)" />
                          <div *ngIf="phoneNo.invalid && phoneNo.touched" class="error">
                            <div *ngIf="phoneNo.errors?.required">Phone Number is required.</div>
                            <div *ngIf="phoneNo.errors?.pattern">Please enter a valid US phone number (e.g., (123) 456-7890 or 123-456-7890).</div>
                          </div>
                        </div>
                      </div>

                      <div class="row he85">
                        <!-- Fleet ID -->
                        <div class="col-xs-12 col-lg-12">
                          <label for="fleetId" class="form-label" style="margin-bottom: -8px;">
                            Fleet ID&nbsp;<span class="text-danger">*</span>
                          </label>
                          <div>
                            <ng-select
                              [(ngModel)]="driverData.fleetId"
                              name="fleetId"
                              #fleetId="ngModel"
                              required
                              [items]="fleetList"
                              bindLabel="name"
                              bindValue="id"
                              [searchable]="true"
                              [clearable]="true"
                              placeholder="Select Fleet ID / Organization">
                              <ng-template ng-label-tmp let-item="item">
                                {{ item.id }} - [{{ item.name }}]
                              </ng-template>
                              <ng-template ng-option-tmp let-item="item">
                                {{ item.id }} - [{{ item.name }}]
                              </ng-template>
                            </ng-select>
                          </div>
                          <div *ngIf="fleetId.invalid && fleetId.touched" class="error">
                            Fleet ID is required.
                          </div>
                        </div>
                      </div>

                      <div class="row he85">
                        <!-- licence Number -->
                        <div class="col-xs-12 col-lg-6">
                          <label for="firstName" class="form-label">Licence Number&nbsp;<span class="text-danger">*</span></label>
                          <input
                            type="text"
                            class="form-input select-data"
                            id="licenceNo"
                            placeholder="licence Number"
                            [(ngModel)]="driverData.licenceNo"
                            name="licenceNo"
                            #licenceNo="ngModel"
                            required
                            autocomplete="off" />
                          <div *ngIf="licenceNo.invalid && licenceNo.touched" class="error">
                            Licence number is required.
                          </div>
                        </div>

                        <!-- Issue State -->
                        <div class="col-xs-12 col-lg-6">
                          <label for="issueState" class="form-label" style="margin-bottom: -8px;">
                            Issue State&nbsp; <span class="text-danger">*</span>
                          </label>
                          <div>
                            <ng-select [(ngModel)]="driverData.issueState"
                              name="issueState" #issueState="ngModel" required
                              [items]="usaStates"
                              bindLabel="name"
                              bindValue="name"
                              placeholder="Select a State">
                              <ng-template ng-option-tmp let-item="item">
                                {{ item.name }} <!-- Display name in the dropdown options -->
                              </ng-template>
                            </ng-select>
                          </div>

                          <div *ngIf="issueState.invalid && issueState.touched" class="error">
                            Issue state is required.
                          </div>
                        </div>




                      </div>

                      <div class="row he85">
                        <!-- Expiry Date -->
                        <div class="col-xs-12 col-lg-6">
                          <label for="expiryDate" class="form-label" >
                            Expiry date&nbsp;<span class="text-danger">*</span>
                          </label>
                          <input
                            placeholder="MM/DD/YYYY"
                            class="form-control"
                            id="expiryDate"
                            name="expiryDate"
                            ngbDatepicker
                            #d2="ngbDatepicker"
                            (click)="d2.toggle()"
                            [(ngModel)]="driverData.expiryDate"
                            (focus)="onFocus()"
                            (blur)="onBlur()"
                            required
                          />
                          <div *ngIf="!driverData.expiryDate" class="error">
                            Expiry date is required.
                          </div>
                        </div>


                              <!-- Driver's Licence Image -->
                      <div class="col-xs-12 col-lg-6">
                        <label for="licenceImage" class="form-label">Upload Driver's Licence (Optional)</label>
                        <input
                          type="file"
                          class="form-control"
                          id="licenceImage"
                          (change)="onlicenceImageSelected($event)"
                          accept="image/jpeg,image/png,image/jpg"
                        />
                        <small class="text-muted">Supported formats: JPEG, PNG (Optional)</small>
                        <div *ngIf="uploadedlicenceImage" class="file-info mt-2">
                          <i class="fas fa-check-circle text-success"></i> Selected: {{ uploadedlicenceImage.name }}
                        </div>
                        <div *ngIf="errorMessage" class="error mt-2">
                          {{ errorMessage }}
                        </div>
                      </div>

                      </div>

                      <!-- Buttons -->
                      <div class="row mr20">
                        <div class="col-xs-12 col-lg-6">
                          <div class="cancel-btn" tooltip="Cancel" (click)="cancelForm()">Cancel</div>
                        </div>
                        <div class="col-xs-12 col-lg-6">
                          <button
                            type="submit"
                            class="submit-btn"
                            tooltip="Submit"
                            [disabled]="driverForm.invalid || !driverForm.dirty">
                            Submit
                          </button>
                        </div>
                      </div>
                    </form>
                  </ng-container>
                   <!-- Association Section - Commented Out -->
                   <!-- <ng-container *ngIf="selectedButton === 'association'">
                    <form (ngSubmit)="saveAssociation()">
                      <div class="form-row">
                        <input type="hidden" name="tripDetailId" [value]= "driverId">
                        <div class="row mt-4">
                          <div class="col-md-12">
                            <label for="driverList" class="mb-2">Fleet Name </label>
                            <ng-select [searchable]="true" class="newSelect1" [clearable]="true"
                                        placeholder="Organization Id/Name" (change)="selectFleetId($event)"
                                        [(ngModel)]="fleetIdData" name="fleetIdAssociation">
                                        <ng-option *ngFor="let fleet of fleetList" [value]="fleet.id">{{fleet.id}} -
                                            [{{fleet.name}}]</ng-option>
                             </ng-select>
                          </div>
                        </div>
                        <div class="row mt-4">
                          <div class="col-md-12">
                            <label for="driverList" class="mb-2">Association VIN to Driver</label>
                            <select id="driverList" name="driverList" class="form-select" [(ngModel)]="selectedVinId" required>
                              <option value="">Select VIN</option>
                              <option *ngFor="let vin of availableVin" [value]="vin.vin">{{ vin.vin }} - ({{ vin.status }})</option>
                            </select>
                          </div>
                        </div>
                      </div>

                      <div class="row mt-4">
                        <div class="col-md-12 text-center">
                          <button type="submit" class="btn btn-primary">
                            {{ mode === 'add' ? 'Add Association' : 'Update Association' }}
                            </button>
                        </div>
                      </div>
                    </form>
                  </ng-container> -->

                  <!-- Dissociation Section - Commented Out -->
                  <!-- <ng-container *ngIf="selectedButton === 'dissociation'">
                    <form (ngSubmit)="removeVinAssociation()">
                      <div class="form-row">
                        <div class="row mt-4">
                          <div class="col-md-12">
                            <label for="vinList" class="mb-2">Select VIN to Dissociate</label>
                            <select id="vinList" name="vinList" class="form-select" [(ngModel)]="selectedAssociationId" required>
                              <option value="" disabled selected>Select VIN</option>
                              <option *ngFor="let vin of associatedVins" [value]="vin.transId || vin.id">
                                {{ vin.alias || vin.vin }} ({{ vin.vin }})
                              </option>
                            </select>
                          </div>
                        </div>
                        <div class="row mt-4">
                          <div class="col-md-12 text-center">
                            <button type="submit" class="btn btn-danger" [disabled]="!selectedAssociationId">
                              Dissociate VIN
                            </button>
                          </div>
                        </div>
                      </div>
                    </form>
                  </ng-container> -->

                  <!-- Single Driver Add End-->
                  <ng-container *ngIf="selectedButton === 'multiple'">
                    <div class="mr40">
                      <div class="row downloadData">
                        <!-- File Upload Section -->
                        <div class="col-xs-12 col-lg-12">
                          <div class="row row-data">
                            <div class="col-xs-12">
                              <div class="image-container">
                                <img src="../../../../../../assets/images/upload-img.svg" class="he100" alt="Upload Image">
                              </div>
                            </div>
                          </div>
                          <div class="row">
                            <div class="col-xs-12 col-lg-12 mr12">
                              <span><a href="javascript:(void)" (click)="triggerFileUpload()" class="fon-all">Click to upload</a>
                                Uploaded data in .csv format</span>
                            </div>
                          </div>
                          <input type="file" #fileInput class="data-display" accept=".csv" (change)="onFileSelected($event)" />
                          <div class="row">
                            <div class="col-xs-12 col-lg-12 mr12">
                              <span *ngIf="uploadedFileName" class="uploaded-file">{{ uploadedFileName }}</span>
                              <span *ngIf="errorMessage" class="uploaded-file-error">{{ errorMessage }}</span>
                            </div>
                          </div>
                        </div>
                      </div>
                      <!-- Sample File Download Section -->
                      <div class="row">
                        <div class="col-xs-12 col-lg-12 text-center">
                          <a type="button" href="javascript:(void)" class="download-link" (click)=" downloadSamples()">Download Sample File</a>
                        </div>
                      </div>
                      <!-- Max File Size -->
                      <div class="row">
                        <div class="col-xs-12 col-lg-12">
                          <h5 class="max-file">Max file size 50 mb</h5>
                        </div>
                      </div>
                    </div>

                    <!-- Action Buttons (Cancel, Submit) -->
                    <div class="row">
                      <div class="col-xs-12 col-lg-6">
                        <div class="cancel-btn" tooltip="Cancel" (click)="cancel()">Cancel</div>
                      </div>
                      <div class="col-xs-12 col-lg-6">
                        <div class="submit-btn" tooltip="Submit" (click)="onSubmit()"  [class.disabled]="!isFileSelected"
                        [attr.disabled]="!isFileSelected ? true : null">Submit</div>
                      </div>
                    </div>

                  </ng-container>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="col-xs-12 col-lg-3">&nbsp;</div>
      </div>
      <!--Add single and bulk driver end-->
    </div>
    <!-- Main Content Right End-->
  </div>
</div>
