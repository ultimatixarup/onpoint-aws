<!-- Show header Heading and Fleet Id-->
<div class="row bread-mar">
    <div class="col-xs-12 col-lg-3">
      <h5 class="heading-dashbaord"><b>Notifications</b></h5>
    </div>
    <ng-container *ngIf="this.user != 'role_user_fleet'">
    <div class="col-xs-12 col-lg-7">
      <div class="fleet-dropdown">
        <ng-select [items]="fleetList" #fleetSelect  bindLabel="fleetName" bindValue="fleetId" placeholder="Organization Ids"
          class="newSelect2 " [(ngModel)]="fleetItem" (change)="selectFleet($event)"
          [searchable]="true">
          <ng-template ng-label-tmp let-item="item">
            <span *ngIf="item">{{item.id}} - {{item.fleetName}}</span>
            <span *ngIf="!item">Select a fleet</span> <!-- default label when null -->
          </ng-template>

          <ng-template ng-option-tmp let-item="item">
            <span *ngIf="item">{{item.id}} - {{item.fleetName}}</span>
          </ng-template>

        </ng-select>
      </div>
    </div>
    <div class="col-xs-12 col-lg-2" style="margin-top:12px;">
      <ng-select
      [searchable]="true"
      class="newSelect2"
      [clearable]="true"
      placeholder="Group Name"
      [items]="groupList"
      bindLabel="name"
      bindValue="id"
      [(ngModel)]="groupIdData"
      (change)="onGroupIdChange($event)">

      <ng-template ng-option-tmp let-item="item">
        <span [ngStyle]="{ 'padding-left.px': item.level * 18 }">
          {{ item.name }}
        </span>
      </ng-template>
    </ng-select>
    </div>

  </ng-container>
    <div class="row" style="margin-top: 20px;">
        <div class="col-xs-12 col-lg-12 d-flex">
          <!-- Label -->
          <div class="mr-24">
            <span class="ft-b">Events</span>
          </div>

          <!-- Email Chips + Add Input -->
          <div class="row g-2 align-items-center flex-wrap">
            <!-- Email Chips -->
            <div class="col-auto" *ngFor="let email of collisionEmailList; let i = index">
              <div
                class="d-flex align-items-center"
                style="gap: 8px; background: #f9f9f9; padding: 6px 12px; border-radius: 16px;">
                <span style="color: #333;">{{ email }}</span>
                <span style="cursor: pointer; color: #999;" (click)="removeCollisionEmail(i)">&#10005;</span>
              </div>
            </div>

            <!-- Add Email Button -->
            <div class="col-auto" *ngIf="!showEmailInputForCollision">
              <img
                src="../../../../assets/images/add_email.svg"
                alt="Add email"
                style="cursor: pointer; width: 24px; height: 24px;"
                (click)="toggleEmailInputCollision()" />
            </div>

            <!-- Email Input Box -->
            <div class="col-auto position-relative" *ngIf="showEmailInputForCollision"
              style="border: 1px solid #ccc; padding: 4px; border-radius: 8px; width: 250px; background: #fff;">

              <input #emailInput [(ngModel)]="newEmail" (keyup.enter)="addEmailForCollision()"
                placeholder="Enter email id..."
                style="width: 100%; padding: 3px; box-sizing: border-box; border: 0px; outline: 0px !important;">

              <button (click)="addEmailForCollision()"
                style="position: absolute; right: 0px; top: 50%; transform: translateY(-50%);
                border: none; background: #28a745; color: white; padding: 8px 10px;
                border-radius: 8px; cursor: pointer;">
                Add
              </button>

              <button (click)="showEmailInputForCollision = false"
                style="position: absolute; right: -36px; top: 50%; transform: translateY(-50%);
                border: none; background: red; color: white; font-size: 18px;
                border-radius: 50%; width: 28px; height: 28px; display: flex;
                align-items: center; justify-content: center;">
                ×
              </button>

              <!-- Domain suggestions -->
              <div *ngIf="newEmail.includes('@')"
                style="position: absolute; top: 100%; left: 0; width: 100%; background: #fff;
                border: 1px solid #ddd; border-radius: 6px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); z-index: 10;">
                <div *ngFor="let domain of domainSuggestions"
                  (click)="selectDomainForCollision(domain, emailInput)"
                  style="cursor: pointer; padding: 8px; color: #333; border-bottom: 1px solid #f0f0f0;">
                  {{ newEmail.split('@')[0] }}@{{ domain }}
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

  </div>
  <!-- Show Header Heading and Fleet Id end -->
  <!-- Collision box -->
  <div class="row main-card">
    <div class="col-xs-12 col-lg-12">
      <h5 class="time-head" ngbTooltip="Email notification is sent when any vehicle has reported an event.">Real-time</h5>
    </div>
  </div>
  <div class="row main-card">
    <div class="col-xs-12 col-lg-12">
      <div class="card1">
        <div class="card-body">
          <div class="row">
            <div class="col-xs-12 col-lg-1">
              <div class="toggle-container" [class.on]="toggles.collision" (click)="toggle('collision')">
                <div class="toggle-button" [class.on]="toggles.collision"></div>
              </div>
            </div>
            <div class="col-xs-12 col-lg-11">
              <h4 class="box-heading">Collision</h4>
              <h5 class="box-heading-data">Set collision email alerts with specified recipients for immediate incident
                notification.</h5>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <!-- Collision box end-->
  <!-- Overspeeding box-->

  <div class="row main-card">
    <div class="col-xs-12 col-lg-12 d-flex mr-16">
      <h5 class="driver-heaidng">Safety Alerts</h5>
      <div class="row" style="margin-top: 3px;">
        <div class="col-xs-12 col-lg-12 d-flex">
          <!-- Show emails -->
          <div class="row g-2 align-items-center flex-wrap">
            <!-- Email Chips -->
            <div
              class="col-auto"
              *ngFor="let email of emailList; let i = index"
              style="display: flex; align-items: center; gap: 8px; background: #f9f9f9; padding: 6px 12px; border-radius: 16px;"
            >
              <span style="color: #333;">{{ email }}</span>
              <span style="cursor: pointer; color: #999;" (click)="removeEmail(i)">&#10005;</span>
            </div>

            <!-- Plus Button -->
            <div class="col-auto" *ngIf="!showEmailInput">
              <img
                src="../../../../assets/images/add_email.svg"
                style="cursor: pointer; width: 24px; height: 24px;"
                (click)="toggleEmailInput()"
              />
            </div>

            <!-- Email Input Box -->
            <div class="col-auto position-relative" *ngIf="showEmailInput"
              style="border: 1px solid #ccc; padding: 4px; border-radius: 8px; width: 250px; background: #fff;">

              <input [(ngModel)]="newEmail1" (keyup.enter)="addEmail()"
                placeholder="Enter email id..."
                style="width: 100%; padding: 3px; box-sizing: border-box; border: none; outline: none;">

              <button (click)="addEmail()"
                style="position: absolute; right: 0px; top: 50%; transform: translateY(-50%);
                border: none; background: #28a745; color: white; padding: 8px 10px;
                border-radius: 8px; cursor: pointer;">
                Add
              </button>

              <button (click)="showEmailInput = false"
                style="position: absolute; right: -36px; top: 50%; transform: translateY(-50%);
                border: none; background: red; color: white; font-size: 18px;
                border-radius: 50%; width: 28px; height: 28px; display: flex;
                align-items: center; justify-content: center;">
                ×
              </button>

              <!-- Suggestions -->
              <div *ngIf="newEmail1.includes('@')"
                style="position: absolute; top: 100%; left: 0; width: 100%; background: #fff;
                border: 1px solid #ddd; border-radius: 6px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); z-index: 10;">

                <div *ngFor="let domain of domainSuggestions" (click)="selectDomain(domain)"
                  style="cursor: pointer; padding: 8px; color: #333; border-bottom: 1px solid #f0f0f0;">
                  {{ newEmail1.split('@')[0] }}@{{ domain }}
                </div>
              </div>
            </div>
          </div>

        </div>
      </div>
    </div>
    <!-- <div class="col-xs-12 col-lg-6" style="margin-top: 12px;">
      <h5 class="time-head mt-3" ngbTooltip="Email notification is sent when any vehicle has reported an event." position="top">Real-time</h5>
    </div> -->
  </div>
  <div class="row row-mar-set main-card">
    <div class="col-xs-12 col-lg-12">
      <div class="card1">
        <div class="card-body">
          <div class="row">
            <div class="col-xs-12 col-lg-1">
              <div class="toggle-container" [class.on]="toggles.overspeeding" (click)="toggle('overspeeding')">
                <div class="toggle-button" [class.on]="toggles.overspeeding"></div>
              </div>
            </div>
            <div class="col-xs-12 col-lg-11">
              <div class="d-flex align-items-start justify-content-between mb-3">
                <!-- Toggle + Label -->
                <div class="d-flex align-items-center gap-2">
                  <div>
                    <h4 class="box-heading">OverSpeeding</h4>
                    <p class="box-heading-data">
                      Get real-time overspeeding email alerts.<br>
                    </p>
                  </div>
                </div>

                <!-- Controls -->
                <div class="align-items-center gap-4">
                  <label style="margin: 10px;">
                    <input type="checkbox"     [checked]="postSpeedLimit === true"
                    (change)="selectThreshold('psl')" name="overspeeding">
                    Road Speed Limit
                  </label>

                  <label style="margin: 10px;">
                    <input (change)="selectThreshold('config')"  type="checkbox"
                    [checked]="postSpeedLimit === false"  name="overspeeding">
                    Configure
                  </label>

                  <div class="d-flex align-items-center">
                    <span class="me-2">Threshold</span>
                    <input type="number"  [(ngModel)]="thresholdValue" class="form-control" style="" name="thresholdInput">
                    <span class="ms-1">mph</span>
                  </div>
                </div>
              </div>

              <!-- Validation message -->
              <div *ngIf= "!postSpeedLimit && (thresholdValue < 40 || thresholdValue > 150)" style="color: orangered; font-size: 12px; margin-top: -12px;float: right;">
                Speed limit must be between 40 - 150 mph
              </div>


            </div>

          </div>
        </div>
      </div>
    </div>
  </div>
  <!-- Overspeeding box end-->
  <!--Harsh Acceleration -->
  <div class="row row-mar-set main-card">
    <div class="col-xs-12 col-lg-12">
      <div class="card2">
        <div class="card-body">
          <div class="row">
            <div class="col-xs-12 col-lg-1">
              <div class="toggle-container" [class.on]="toggles.harshAcceleration" (click)="toggle('harshAcceleration')">
                <div class="toggle-button" [class.on]="toggles.harshAcceleration"></div>
              </div>
            </div>
            <div class="col-xs-12 col-lg-11">
              <h4 class="box-heading">Harsh Acceleration (HA)</h4>
              <h5 class="box-heading-data">Set email alerts for harsh acceleration events.</h5>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <!--Harsh Acceleration end-->
  <!--Harsh Braking -->
  <div class="row row-mar-set main-card">
    <div class="col-xs-12 col-lg-12">
      <div class="card2">
        <div class="card-body">
          <div class="row">
            <div class="col-xs-12 col-lg-1">
              <div class="toggle-container" [class.on]="toggles.harshBraking" (click)="toggle('harshBraking')">
                <div class="toggle-button" [class.on]="toggles.harshBraking"></div>
              </div>
            </div>
            <div class="col-xs-12 col-lg-11">
              <h4 class="box-heading">Harsh Braking (HB)</h4>
              <h5 class="box-heading-data">Set email alerts for harsh braking events.</h5>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <!--Harsh Braking end -->
  <!--Harsh Cornering -->
  <div class="row row-mar-set main-card">
    <div class="col-xs-12 col-lg-12">
      <div class="card2">
        <div class="card-body">
          <div class="row">
            <div class="col-xs-12 col-lg-1">
              <div class="toggle-container" [class.on]="toggles.harshCornering" (click)="toggle('harshCornering')">
                <div class="toggle-button" [class.on]="toggles.harshCornering"></div>
              </div>
            </div>
            <div class="col-xs-12 col-lg-11">
              <h4 class="box-heading">Harsh Cornering (HC)</h4>
              <h5 class="box-heading-data">Set email alerts for harsh cornering events.</h5>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <!--Harsh Cornering end -->
  <!--Idling -->
  <div class="row row-mar-set main-card">
    <div class="col-xs-12 col-lg-12 ">
      <div class="card2">
        <div class="card-body">
          <div class="row">
            <div class="col-xs-12 col-lg-1">
              <div class="toggle-container" [class.on]="toggles.idling" (click)="toggle('idling')">
                <div class="toggle-button" [class.on]="toggles.idling"></div>
              </div>
            </div>
            <div class="col-xs-12 col-lg-11">
              <h4 class="box-heading">Idling</h4>
              <h5 class="box-heading-data">Set email alerts for idle time directly to designated recipients.</h5>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <!--Idling end-->
  <!-- Save button -->
  <div class="row main-card">
    <div class="col-xs-12 col-lg-10">&nbsp;</div>
    <div class="col-xs-12 col-lg-2">
      <button class="save-btn" style="float: right;" (click)="submitUpdateNotificationAlerts()">Save</button>
    </div><br>
    <div class="row">
      <div class="col-xs-12 col-lg-12">
        <h5 *ngIf="showFleetIdError" class="errMessage">* Please select Fleet Id</h5>
      </div>
    </div>
  </div>
  <!-- Save button end-->
  <!--Spinner-->
  <ngx-spinner bdColor="rgba(0, 0, 0, 0.8)" size="large" color="#fff" type="ball-circus" [fullScreen]="true">
    <p style="color: white">Loading...</p>
  </ngx-spinner>
  <!--Spinner end-->
