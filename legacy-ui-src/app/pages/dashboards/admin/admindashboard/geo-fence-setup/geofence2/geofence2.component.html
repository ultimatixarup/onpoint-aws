<div class="page-content page-content-main">
  <div class="row sideMenuItem">
    <div class="container">
      <div class="col-xs-12 content-right">

        <!-- SECTION 1: HEADING & BREADCRUMB -->
        <div class="row">
          <div class="col-xs-12 col-lg-12">
            <span class="breadcrumb-left">
              <h1 class="login-headline heading-title">Geofence</h1>
            </span>
            <span class="breadcrumb-right mr-8">
              <ol class="breadcrumb">
                <!-- Admin breadcrumb -->
                <ng-container *ngIf="user =='admin'">
                  <li class="breadcrumb-item">
                    <a routerLink="/adlp/admin" class="breadcrumb-h6">
                      <i class="bx bx-home-circle"></i>
                    </a>
                  </li>
                  <li class="breadcrumb-item inactive-bread">
                    <a routerLink="/adlp/admin/dashboardAdmin">Dashboard</a>
                  </li>
                  <li class="breadcrumb-item text-selected active-bread">Geofence</li>
                </ng-container>

                <!-- Non-admin breadcrumb -->
                <ng-container *ngIf="user !='admin'">
                  <li class="breadcrumb-item">
                    <a routerLink="/adlp/admin/admindashboard/dashboardfleet" class="breadcrumb-h6">
                      <i class="bx bx-home-circle"></i>
                    </a>
                  </li>
                  <li class="breadcrumb-item inactive-bread">
                    <a routerLink="/adlp/admin/admindashboard/dashboardfleet">Dashboard</a>
                  </li>
                  <li class="breadcrumb-item text-selected active-bread">Geofence</li>
                </ng-container>
              </ol>
            </span>
          </div>
        </div>

        <!-- SECTION 2: FILTER/CONTROL BAR -->
        <div class="row consumer-pad">
          <!-- Consumer Selector (Admin Only) -->
          <div class="col-xs-12 col-lg-2">
            <ng-container *ngIf="this.user === 'admin'">
              <app-common-consumer (consumerChange)="selectConsumer($event)"></app-common-consumer>
            </ng-container>
          </div>

          <!-- Date Range Filter -->
          <div class="col-xs-12 col-lg-2 mr-6">
            <!-- <ng-select
              bindLabel="label"
              bindValue="value"
              placeholder="Select Time Period"
              [(ngModel)]="selectedPeriod"
              (change)="onTimePeriodChange($event)"
              class="newSelect1">
              <ng-option *ngFor="let period of timePeriods" [value]="period.value">
                {{ period.label }}
              </ng-option>
            </ng-select> -->
          </div>

          <!-- Search Input -->
          <div class="col-xs-12 col-lg-2 mr-6">
            <input
              type="text"
              class="search-input"
              placeholder="Search Geofence..."
              [(ngModel)]="searchTerm"
            />
          </div>

          <!-- Add Geofence Button -->
          <div class="col-xs-12 col-lg-3 mr-6">
            <button class="add-geofence-btn" (click)="openAddGeofenceModal(addGeofenceModal)">
              <i class="fa fa-plus plus-icon-orange"></i> Add Geofence
            </button>
          </div>



          <!-- Fleet Selector -->
          <div class="col-xs-12 col-lg-3 mr-6">
            <ng-select
              [searchable]="true"
              class="newSelect1"
              [clearable]="true"
              placeholder="Organization Id/Name"
              [(ngModel)]="fleetIdData"
              (ngModelChange)="onFleetIdChange()">
              <ng-option *ngFor="let fleet of fleetList" value="{{ fleet.id }}">
                {{ fleet.id }} - [{{ fleet.name }}]
              </ng-option>
            </ng-select>
          </div>
        </div>

        <!-- Custom Date Range Card -->
        <!-- <div class="row consumer-pad" *ngIf="isCardOpen">
          <div class="col-xs-12 col-lg-12">
            <div class="geofence-panel-header" style="background: #fff; padding: 15px; border-radius: 10px; margin-bottom: 15px;">
              <div class="panel-title">
                <h4>Custom Date Range</h4>
                <span class="panel-subtitle">Select your date range</span>
              </div>
              <div class="panel-controls">
                <div class="date-field">
                  <label>Start Date</label>
                  <input
                    type="date"
                    [(ngModel)]="fromDate"
                  />
                </div>
                <div class="date-field">
                  <label>End Date</label>
                  <input
                    type="date"
                    [(ngModel)]="toDate"
                  />
                </div>
                <button class="apply-btn" (click)="onDateRangeSelected({fromDate: fromDate, toDate: toDate})">Apply</button>
                <button class="apply-btn" style="background: #6c757d; margin-left: 10px;" (click)="isCardOpen = false">Cancel</button>
              </div>
            </div>
          </div>
        </div> -->

        <!-- SECTION 3: TABLE -->
        <div class="table-container mr-24">
          <div class="row mr-table mr-12">
            <div class="col-lg-12 col-xs-12">
              <div class="table-wrapper docs-wrapper">
                <div class="table-responsive table-b">
                  <table class="table">
                    <thead class="table-head">
                      <tr>
                        <th class="table-column-width">Date Created</th>
                        <th class="table-column-width7">Geofence Name</th>
                        <th class="table-column-width">Geofence Address</th>
                        <th class="table-column-width">Radius (meters)</th>
                        <th class="table-column-width">Mapped Vehicles</th>
                        <th class="table-column-width">Map Vehicle(s)</th>
                        <th class="table-column-width">Status (Active/Inactive)</th>
                        <th class="table-column-width">Date Inactive</th>
                        <!-- <th class="table-column-width">Notification Status (ON/OFF)</th> -->
                         <th class="table-column-width">Action</th>

                      </tr>
                    </thead>
                    <tbody>
                      <!-- Loading State -->
                      <ng-container *ngIf="isLoading">
                        <tr>
                          <td colspan="9" class="text-center">
                            <i class="fa fa-spinner fa-spin icon-loading" style="font-size: 20px;"></i>
                          </td>
                        </tr>
                      </ng-container>

                      <!-- Data Rows -->
                      <ng-container *ngIf="!isLoading && filteredData?.length > 0">
                        <ng-container *ngFor="let geofence of filteredData">
                          <tr>
                            <td class="table-column-width">
                              <span>{{ geofence.formattedCreatedDate || 'Loading...' }}</span>
                            </td>
                            <td class="table-column-width7">
                              <span class="geofence-name-cell">
                                <!-- <button
                                  type="button"
                                  class="expand-toggle"
                                  (click)="toggleGeofencePanel(geofence)"
                                  [class.is-open]="isGeofenceExpanded(geofence.geofenceId || geofence.id)"
                                  aria-label="Expand geofence summary">
                                  <img
                                    src="../../../../../../../assets/images/add-group.svg"
                                    alt="Expand"
                                    class="action-img"
                                  />
                                </button> -->
                                <span>{{ geofence.geofenceName }}</span>

                              </span>
                            </td>
                            <td class="table-column-width">
                              <span>{{ geofence.address || 'N/A' }}</span>
                            </td>
                            <td class="table-column-width">
                              <span>{{ geofence.radiusInMeters | number:'1.0-0' }}</span>
                            </td>
                            <td class="table-column-width">
                              <a
                                style="cursor: pointer; font-size: 12px; font-weight: 500; color: blue; text-decoration: underline; text-underline-offset: 3px"
                                (click)="openMappedVehiclesModal(mappedVehiclesModal, geofence)">
                                {{ geofence.mappedVehicles?.length || 0 }}
                              </a>
                            </td>
                            <td class="table-column-width">
                              <button class="map-vins-btn" (click)="openMapVinsModal(mapVinsModal, geofence)">
                                Map VIN(s)
                              </button>
                            </td>
                            <td class="table-column-width">
                              <div class="status-toggle-wrapper">
                                <span class="toggle-label" [class.active]="geofence.status === true || geofence.isActive === true">
                                  {{ geofence.status === true || geofence.isActive === true ? 'Active' : 'Inactive' }}
                                </span>
                                <label class="toggle-switch" [class.disabled]="isStatusUpdating(geofence.geofenceId)">
                                  <input
                                    type="checkbox"
                                    [checked]="geofence.status === true || geofence.isActive === true"
                                    [disabled]="isStatusUpdating(geofence.geofenceId)"
                                    (change)="updateStatus(geofence, !(geofence.status === true || geofence.isActive === true))">
                                  <span class="slider"></span>
                                </label>
                                <i *ngIf="isStatusUpdating(geofence.geofenceId)" class="fa fa-spinner fa-spin status-spinner"></i>
                              </div>
                            </td>
                            <td class="table-column-width">
                              <span>{{ geofence.formattedInactiveDate || 'N/A' }}</span>
                            </td>
                            <!-- <td class="table-column-width">
                              <span
                                class="notification-badge notification-clickable"
                                [ngClass]="{
                                  'notification-on': geofence.notificationEnabled === true || geofence.notificationStatus === 'ON',
                                  'notification-off': geofence.notificationEnabled === false || geofence.notificationStatus === 'OFF',
                                  'notification-updating': isGeofenceUpdating(geofence)
                                }"
                                (click)="!isGeofenceUpdating(geofence) && toggleNotificationStatus(geofence)"
                                [style.cursor]="isGeofenceUpdating(geofence) ? 'not-allowed' : 'pointer'"
                                [style.opacity]="isGeofenceUpdating(geofence) ? '0.6' : '1'"
                                title="Click to toggle notification">
                                <i *ngIf="isGeofenceUpdating(geofence)" class="fa fa-spinner fa-spin" style="margin-right: 4px;"></i>
                                {{ geofence.notificationEnabled === true || geofence.notificationStatus === 'ON' ? 'ON' : 'OFF' }}
                              </span>
                            </td> -->
                            <td>
                              <div class="action-buttons-group">
                                <button
                                    type="button"
                                    class="report-icon-btn"
                                    (click)="navigateToGeofenceReport(geofence, $event)"
                                    title="View Geofence Report">
                                    <i class="fa fa-eye"></i>
                                  </button>
                                <button
                                    type="button"
                                    class="delete-icon-btn"
                                    (click)="deleteGeofence(geofence, $event)"
                                    title="Delete Geofence">
                                    <i class="fa fa-trash"></i>
                                  </button>
                              </div>
                            </td>
                          </tr>
                          <tr class="geofence-expand-row" *ngIf="geofence.geofenceId || geofence.id as geofenceId">
                            <td colspan="9">
                              <div class="geofence-expand-panel" [class.is-open]="isGeofenceExpanded(geofenceId)">
                                <div class="geofence-panel-inner" *ngIf="getGeofenceStatsState(geofenceId) as stats">

                                  <!-- Date Range Filter Dropdown - Moved to Right -->
                                  <div style="margin-bottom: 15px; display: flex; justify-content: flex-end;">
                                    <ng-select
                                      bindLabel="label"
                                      bindValue="value"
                                      placeholder="Select Time Period"
                                      [(ngModel)]="selectedPeriod"
                                      (change)="onTimePeriodChange($event, geofenceId)"
                                      class="newSelect1"
                                      style="width: 200px;">
                                      <ng-option *ngFor="let period of timePeriods" [value]="period.value">
                                        {{ period.label }}
                                      </ng-option>
                                    </ng-select>
                                  </div>

                                  <div class="vin-summary-table">
                                    <table class="table">
                                      <thead class="table-head">
                                        <tr>
                                          <th class="vin-expand-col"></th>
                                          <th>Vehicle</th>
                                          <th>VIN</th>
                                          <th>Entries</th>
                                          <th>Exits</th>
                                          <th>Duration</th>
                                          <th>Last Entry</th>
                                          <th>Last Exit</th>
                                          <th>Last Duration</th>
                                          <th>Status</th>
                                        </tr>
                                      </thead>
                                      <tbody>
                                        <tr *ngIf="stats.loading">
                                          <td colspan="10" class="text-center">
                                            <i class="fa fa-spinner fa-spin icon-loading" style="font-size: 20px;"></i>
                                          </td>
                                        </tr>

                                        <ng-container *ngIf="!stats.loading && stats.vehicles.length > 0">
                                          <ng-container *ngFor="let vinRow of stats.vehicles">
                                            <tr class="vin-summary-row">
                                              <td class="vin-expand-col">
                                                <!-- <button
                                                  type="button"
                                                  class="expand-toggle vin-expand-toggle"
                                                  (click)="toggleVinPanel(geofenceId, vinRow)"
                                                  [class.is-open]="isVinExpanded(geofenceId, vinRow.vin)"
                                                  aria-label="Expand VIN timeline">
                                                  <img
                                                    src="../../../../../../../assets/images/add-group.svg"
                                                    alt="Expand"
                                                    class="action-img"
                                                  />
                                                </button> -->
                                              </td>
                                              <td class="vin-summary-cell">
                                                <div class="vin-summary-title">
                                                  <div class="vin-summary-name">{{ vinRow.vehicleName || 'Vehicle' }}</div>
                                                </div>
                                              </td>
                                              <td class="vin-summary-vin">{{ vinRow.vin }}</td>
                                              <td>{{ vinRow.entries }}</td>
                                              <td>{{ vinRow.exits }}</td>
                                              <td>{{ vinRow.duration }}</td>
                                              <td>{{ vinRow.lastEntry }}</td>
                                              <td>{{ vinRow.lastExit }}</td>
                                              <td>{{ vinRow.lastDuration }}</td>
                                              <td>
                                                <span
                                                  class="status-badge"
                                                  [ngClass]="{
                                                    'status-inside': isInsideStatus(vinRow.status),
                                                    'status-outside': !isInsideStatus(vinRow.status)
                                                  }">
                                                  {{ vinRow.status || 'OUTSIDE' }}
                                                </span>
                                              </td>
                                            </tr>
                                            <tr class="vin-expand-row">
                                              <td colspan="10">
                                                <div
                                                  class="vin-expand-panel"
                                                  [class.is-open]="isVinExpanded(geofenceId, vinRow.vin)">
                                                  <div class="vin-panel-inner" *ngIf="getVinTimelineState(geofenceId, vinRow.vin) as vinState">
                                                    <div class="vin-panel-header">
                                                      <div class="vin-panel-title">Geofence VIN Detailed Report</div>
                                                      <!-- <div class="vin-panel-subtitle">
                                                        {{ vinRow.vehicleName }} Â· {{ vinRow.vin }}
                                                      </div> -->
                                                    </div>
                                                    <div class="vin-events-table">
                                                      <table class="table">
                                                        <thead class="table-head">
                                                          <tr>
                                                            <th>Entry Date &amp; Time</th>
                                                            <th>Exit Date &amp; Time</th>
                                                            <th>Duration (Days:Hr:Min)</th>
                                                            <th>Odometer</th>
                                                            <th>Fuel Level</th>
<<<<<<< HEAD
                                                            <th>Status</th>
=======
>>>>>>> 26d97970 (add new ui  geofence)
                                                            <th>Notes</th>
                                                            <th>Vehicle Health</th>
                                                          </tr>
                                                        </thead>
                                                        <tbody>
                                                          <tr *ngIf="vinState.loading">
                                                            <td colspan="4" class="text-center">
                                                              <i class="fa fa-spinner fa-spin icon-loading" style="font-size: 18px;"></i>
                                                            </td>
                                                          </tr>
                                                          <ng-container *ngIf="!vinState.loading && vinState.events.length > 0">
                                                            <tr
                                                              *ngFor="let event of vinState.events; let i = index"
                                                              [class.event-inside]="isInsideStatus(event.eventType)">
                                                              <td>{{ event.entryTime || '--' }}</td>
                                                              <td>
                                                                <span
                                                                  [class.event-empty]="event.isOngoing && event.isLatest && (event.eventType || '') === 'IN'">
                                                                  {{
                                                                    event.isOngoing && event.isLatest && (event.eventType || '') === 'IN'
                                                                      ? 'Still inside'
                                                                      : (event.exitTime && event.exitTime !== '--' ? event.exitTime : '--')
                                                                  }}
                                                                </span>
                                                              </td>
                                                              <td>{{ event.duration }}</td>
                                                              <td>{{ event.odometerReading }}</td>
                                                              <td>{{ event.fuelLevelGallons }}</td>
                                                              <td>
                                                                <span class="event-type">{{ event.eventType || '--' }}</span>
                                                              </td>
                                                              <td class="notes-cell" [title]="event.notes || ''"><span class="notes-text">{{ event.notes || '--' }}</span></td>
                                                              <td><button class="viewMorebtns">
                                                                <img src="../../../../../assets/images/blackdot.svg" class="button-icon">
                                                              </button></td>
                                                            </tr>
                                                          </ng-container>
                                                          <tr *ngIf="!vinState.loading && vinState.events.length === 0">
                                                            <td colspan="4" class="text-center no-data-text">
                                                              No timeline data available.
                                                            </td>
                                                          </tr>
                                                        </tbody>
                                                      </table>
                                                    </div>
                                                  </div>
                                                </div>
                                              </td>
                                            </tr>
                                          </ng-container>
                                        </ng-container>

                                        <tr *ngIf="!stats.loading && stats.vehicles.length === 0">
                                          <td colspan="10" class="text-center no-data-text">
                                            No VIN statistics found for this geofence.
                                          </td>
                                        </tr>
                                      </tbody>
                                    </table>
                                  </div>
                                </div>
                              </div>
                            </td>
                          </tr>
                        </ng-container>
                      </ng-container>

                      <!-- No Data State -->
                      <ng-container *ngIf="!isLoading && (!filteredData || filteredData.length === 0)">
                        <tr>
                          <td colspan="10">
                            <h5 class="failedData">No data found ...</h5>
                          </td>
                        </tr>
                      </ng-container>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
        </div>

      </div>
    </div>
  </div>
</div>

<!-- MODAL: Mapped Vehicles -->
<ng-template #mappedVehiclesModal let-modal class="modal-width">
  <div class="modal-header">
    <div class="row" style="width: 110%;">
      <div class="col-xs-12 col-lg-10">
        <h5 class="modal-title mt-0" style="font-family: 'Poppins'">
          Mapped Vehicles: {{ mappedVehicles?.length || 0 }}
        </h5>
      </div>
      <div class="col-xs-12 col-lg-1">
        <button
          type="button"
          class="btn-close"
          (click)="modal.dismiss('Cross click')"
          style="margin-top: 5px;"
          aria-hidden="true">
        </button>
      </div>
    </div>
  </div>
  <div class="modal-body modal-height">
    <div class="container">
      <div class="row" style="width: 106%;">
        <div class="over">
          <div class="checkbox-scroll-container" *ngIf="mappedVehicles?.length > 0">
            <label class="custom-checkbox label-value" *ngFor="let vehicle of mappedVehicles">
              <input type="checkbox" [checked]="true" disabled />
              <span class="checkmark"></span>
              {{ vehicle.alias || vehicle.vin || vehicle }}
            </label>
          </div>
          <div *ngIf="!mappedVehicles || mappedVehicles.length === 0">
            <p class="failedData">No vehicles mapped to this geofence.</p>
          </div>
        </div>
      </div>
    </div>
  </div>
</ng-template>

<!-- MODAL: Map VINs -->
<ng-template #mapVinsModal let-modal class="modal-width">
  <div class="modal-header">
    <div class="row" style="width: 110%;">
      <div class="col-xs-12 col-lg-10">
        <h5 class="modal-title mt-0" style="font-family: 'Poppins'">
          Map VIN(s): {{ selectedGeofenceForMapping?.geofenceName }}
        </h5>
        <div class="modal-subtitle" *ngIf="selectedGeofenceForMapping?.geofenceId">
          Geofence ID: {{ selectedGeofenceForMapping?.geofenceId }}
        </div>
      </div>
      <div class="col-xs-12 col-lg-1">
        <button
          type="button"
          class="btn-close"
          (click)="modal.dismiss('Cross click')"
          [disabled]="isMapping"
          style="margin-top: 5px;"
          aria-hidden="true">
        </button>
      </div>
    </div>
  </div>

  <div class="modal-body mapping-modal-body">
    <div class="row mb-3">
      <div class="col-xs-12 col-lg-6">
        <input
          type="text"
          class="search-input"
          placeholder="Search by VIN or Alias..."
          [(ngModel)]="vinSearchTerm"
          (ngModelChange)="updateSelectAllVinsStatus()"
          [disabled]="isMapping"
        />
      </div>
      <div class="col-xs-12 col-lg-6">
        <div class="mapping-summary" *ngIf="mappingStatuses.length">
          <span>{{ mappingDoneCount }}/{{ mappingStatuses.length }} completed</span>
          <span class="mapping-failed" *ngIf="mappingFailedCount > 0">
            Failed: {{ mappingFailedCount }}
          </span>
        </div>
      </div>
    </div>

    <div class="row">
      <div class="col-xs-12 col-lg-6">
        <div class="vin-list-card">
          <div class="vin-list-header">
            <label class="custom-checkbox label-value">
              <input
                type="checkbox"
                [(ngModel)]="selectAllVins"
                (change)="toggleSelectAllVins()"
                [disabled]="isMapping || filteredVinList.length === 0"
              />
              <span class="checkmark"></span>
              Select All
            </label>
            <span class="vin-count">{{ filteredVinList.length }} vehicles</span>
          </div>

          <div class="vin-list-body">
            <div *ngIf="isLoadingVins" class="text-center">
              <i class="fa fa-spinner fa-spin icon-loading" style="font-size: 20px;"></i>
            </div>
            <div *ngIf="!isLoadingVins && filteredVinList.length === 0" class="failedData">
              No vehicles found ...
            </div>
            <div class="checkbox-scroll-container" *ngIf="!isLoadingVins && filteredVinList.length > 0">
            <label class="custom-checkbox label-value" [ngClass]="{ 'vin-disabled': vehicle.isMapped }" *ngFor="let vehicle of filteredVinList">
              <input
                type="checkbox"
                [(ngModel)]="vehicle.checked"
                (change)="updateSelectAllVinsStatus()"
                [disabled]="isMapping || vehicle.isMapped"
              />
                <span class="checkmark"></span>
                <span class="vin-details">
                  <span class="vin-code">{{ vehicle.vin }}</span>
                  <span class="vin-alias-text" *ngIf="vehicle.alias && vehicle.alias !== vehicle.vin">
                    {{ vehicle.alias }}
                  </span>
                </span>
              </label>
            </div>
          </div>
        </div>
      </div>

      <div class="col-xs-12 col-lg-6">
        <div class="mapping-status-card">
          <div class="status-header">Mapping Status</div>
          <div class="status-list" *ngIf="mappingStatuses.length > 0; else statusEmpty">
            <div class="status-row" *ngFor="let status of mappingStatuses">
              <div class="status-info">
                <div class="status-vin">{{ status.vin }}</div>
                <div class="status-alias" *ngIf="status.alias && status.alias !== status.vin">
                  {{ status.alias }}
                </div>
                <div class="status-error" *ngIf="status.status === 'failed' && status.message">
                  {{ status.message }}
                </div>
              </div>
              <span
                class="status-pill"
                [ngClass]="{
                  'status-pending': status.status === 'pending',
                  'status-mapping': status.status === 'mapping',
                  'status-success': status.status === 'success',
                  'status-failed': status.status === 'failed'
                }"
              >
                <ng-container *ngIf="status.status === 'mapping'">
                  <i class="fa fa-spinner fa-spin status-spinner"></i>
                  Mapping
                </ng-container>
                <ng-container *ngIf="status.status === 'success'">
                  Mapped
                </ng-container>
                <ng-container *ngIf="status.status === 'pending'">
                  Pending
                </ng-container>
                <ng-container *ngIf="status.status === 'failed'">
                  Failed
                </ng-container>
              </span>
            </div>
          </div>
          <ng-template #statusEmpty>
            <div class="status-empty">
              Select vehicles and click Map VIN(s) to start mapping.
            </div>
          </ng-template>
        </div>
      </div>
    </div>
  </div>

  <div class="modal-footer">
    <button
      type="button"
      class="btn btn-cancel"
      (click)="modal.dismiss('Cancel')"
      [disabled]="isMapping">
      Close
    </button>
    <button
      type="button"
      class="btn btn-submit"
      (click)="mapSelectedVins()"
      [disabled]="isMapping || !hasSelectedVins">
      <span *ngIf="!isMapping">Map VIN(s)</span>
      <span *ngIf="isMapping">
        <i class="fa fa-spinner fa-spin"></i> Mapping...
      </span>
    </button>
  </div>
</ng-template>

<!-- MODAL: Geofence Events -->
<ng-template #geofenceEventsModal let-modal class="modal-width">
  <div class="modal-header">
    <div class="row" style="width: 110%;">
      <div class="col-xs-12 col-lg-10">
        <h5 class="modal-title mt-0" style="font-family: 'Poppins'">
          Geofence Events: {{ selectedGeofenceForEvents?.geofenceName }} ({{ totalElements }} total events)
        </h5>
      </div>
      <div class="col-xs-12 col-lg-1">
        <button
          type="button"
          class="btn-close"
          (click)="modal.dismiss('Cross click')"
          style="margin-top: 5px;"
          aria-hidden="true">
        </button>
      </div>
    </div>
  </div>

  <div class="modal-body modal-events-height">
    <!-- Search Bar -->
    <div class="row mb-3">
      <div class="col-xs-12 col-lg-4">
        <input
          type="text"
          class="search-input"
          placeholder="Search by VIN or Alias..."
          [(ngModel)]="eventSearchTerm"
          (ngModelChange)="filterEvents()"
        />
      </div>
    </div>

    <!-- Events Table -->
    <div class="table-responsive events-table-wrapper">
      <table class="table table-events">
        <thead class="table-head">
          <tr>
            <th>VIN / Alias</th>
            <th>Event Type</th>
            <th>Timestamp</th>
            <th>Duration</th>
          </tr>
        </thead>
        <tbody>
          <!-- Loading State -->
          <ng-container *ngIf="isLoadingEvents">
            <tr>
              <td colspan="4" class="text-center">
                <i class="fa fa-spinner fa-spin icon-loading" style="font-size: 20px;"></i>
              </td>
            </tr>
          </ng-container>

          <!-- Event Rows -->
          <ng-container *ngIf="!isLoadingEvents && filteredEventsList?.length > 0">
            <tr *ngFor="let event of filteredEventsList">
              <td>
                <div class="vin-alias">
                  <div class="vin-text">{{ event.vin }}</div>
                  <div class="alias-text" *ngIf="event.vinAlias">{{ event.vinAlias }}</div>
                </div>
              </td>
              <td>
                <span class="event-badge" [ngClass]="{
                  'badge-in': event.eventType === 'IN',
                  'badge-out': event.eventType === 'OUT'
                }">
                  {{ event.eventType }}
                </span>
              </td>
              <td>{{ event.timestamp }}</td>
              <td>
                <span [ngClass]="{'ongoing-text': event.isOngoing}">
                  {{ event.durationFormatted }}
                </span>
              </td>
            </tr>
          </ng-container>

          <!-- No Data State -->
          <ng-container *ngIf="!isLoadingEvents && (!filteredEventsList || filteredEventsList.length === 0)">
            <tr>
              <td colspan="4">
                <h5 class="failedData">No events found...</h5>
              </td>
            </tr>
          </ng-container>
        </tbody>
      </table>
    </div>

    <!-- Pagination -->
    <div class="pagination-wrapper" *ngIf="totalPages > 1">
      <nav aria-label="Page navigation">
        <ul class="pagination justify-content-center">
          <!-- Previous Button -->
          <li class="page-item" [class.disabled]="currentPage === 0">
            <a class="page-link" (click)="goToPage(currentPage - 1)" aria-label="Previous">
              <span aria-hidden="true">&laquo;</span>
            </a>
          </li>

          <!-- Page Numbers -->
          <li class="page-item"
              *ngFor="let page of getPageNumbers()"
              [class.active]="page === currentPage">
            <a class="page-link" (click)="goToPage(page)">{{ page + 1 }}</a>
          </li>

          <!-- Next Button -->
          <li class="page-item" [class.disabled]="currentPage === totalPages - 1">
            <a class="page-link" (click)="goToPage(currentPage + 1)" aria-label="Next">
              <span aria-hidden="true">&raquo;</span>
            </a>
          </li>
        </ul>
      </nav>
    </div>
  </div>
</ng-template>

<!-- MODAL: Add Geofence -->
<ng-template #addGeofenceModal let-modal class="modal-width">
  <div class="modal-header">
    <h5 class="modal-title" style="font-family: 'Poppins'">Add New Geofence</h5>
    <button
      type="button"
      class="btn-close"
      (click)="modal.dismiss('Cross click')"
      aria-hidden="true">
    </button>
  </div>

  <div class="modal-body add-geofence-modal-body">
    <form [formGroup]="addGeofenceForm">
      <div class="row">
        <!-- Left Side: Form -->
        <div class="col-lg-4 col-xs-12 form-section">
          <!-- Geofence Name -->
          <div class="form-group mb-3">
            <label class="form-label">Geofence Name <span class="required">*</span></label>
            <input
              type="text"
              class="form-control"
              formControlName="name"
              placeholder="Enter geofence name"
            />
            <div class="error-text" *ngIf="addGeofenceForm.get('name')?.touched && addGeofenceForm.get('name')?.invalid">
              Name is required (min 3 characters)
            </div>
          </div>

          <!-- Fleet ID -->
          <div class="form-group mb-3">
            <label class="form-label">Fleet / Organization <span class="required">*</span></label>
            <ng-select
              *ngIf="user === 'admin' || user === 'role_consumer_fleet'"
              formControlName="fleetId"
              [items]="fleetList"
              bindLabel="name"
              bindValue="id"
              placeholder="Select Organization"
              class="fleet-select">
              <ng-template ng-option-tmp let-item="item">
                {{ item.id }} - {{ item.name }}
              </ng-template>
            </ng-select>
            <input
              *ngIf="user === 'role_user_fleet' || user === 'role_org_group'"
              type="text"
              class="form-control"
              [value]="fleetIdValueNew"
              disabled
            />
            <div class="error-text" *ngIf="addGeofenceForm.get('fleetId')?.touched && addGeofenceForm.get('fleetId')?.invalid">
              Fleet is required
            </div>
          </div>

          <!-- Address Search -->
          <div class="form-group mb-3">
            <label class="form-label">Search Location</label>
            <input
              type="text"
              id="addressSearch"
              class="form-control"
              placeholder="Search for an address..."
            />
            <small class="form-text">Click on map or search address to set location</small>
          </div>

          <div class="form-group mb-3">
            <label class="form-label">Place Name</label>
            <input
              type="text"
              class="form-control"
              formControlName="addressName"
              placeholder="Auto-filled from Google search"
              readonly
            />
          </div>

          <div class="form-group mb-3">
            <label class="form-label">Selected Address</label>
            <input
              type="text"
              class="form-control"
              formControlName="address"
              placeholder="Auto-filled from Google search"
              readonly
            />
          </div>

          <!-- Radius -->
          <div class="form-group mb-3">
            <label class="form-label">Radius (meters) <span class="required">*</span></label>
            <input
              type="number"
              class="form-control"
              formControlName="radius"
              (input)="onRadiusChange()"
              min="50"
              max="500"
              placeholder="100"
            />
            <small class="form-text">Range: 50-500 meters</small>
            <div class="error-text" *ngIf="addGeofenceForm.get('radius')?.touched && addGeofenceForm.get('radius')?.invalid">
              Radius must be between 50 and 500 meters
            </div>
          </div>

          <!-- Description -->
          <div class="form-group mb-3">
            <label class="form-label">Description</label>
            <textarea
              class="form-control"
              formControlName="description"
              rows="3"
              placeholder="Enter description (optional)">
            </textarea>
          </div>

          <!-- Hidden Fields (auto-populated from map) -->
          <input type="hidden" formControlName="latitude" />
          <input type="hidden" formControlName="longitude" />
        </div>

        <!-- Right Side: Map -->
        <div class="col-lg-8 col-xs-12 map-section">
          <div class="map-container">
            <agm-map
              [latitude]="latitude"
              [longitude]="longitude"
              [zoom]="zoom"
              [mapTypeId]="mapTypeId"
              [streetViewControl]="false"
              [fullscreenControl]="true"
              (mapReady)="onMapReady($event)"
              (mapClick)="onMapClick($event)"
              style="height: 500px;">
            </agm-map>

            <!-- Map Type Toggle -->
            <div class="map-toggle-buttons">
              <button
                type="button"
                class="map-toggle-btn"
                [class.active]="mapTypeId === 'roadmap'"
                (click)="mapTypeId = 'roadmap'">
                Map
              </button>
              <button
                type="button"
                class="map-toggle-btn"
                [class.active]="mapTypeId === 'satellite'"
                (click)="mapTypeId = 'satellite'">
                Satellite
              </button>
            </div>
          </div>

          <div class="map-instructions">
            <i class="fa fa-info-circle"></i>
            <span>Click on the map or search for a location to place the geofence center. Drag the circle or adjust radius to customize.</span>
          </div>
        </div>
      </div>
    </form>
  </div>

  <div class="modal-footer">
    <button
      type="button"
      class="btn btn-cancel"
      (click)="modal.dismiss('Cancel')"
      [disabled]="isSubmitting">
      Cancel
    </button>
    <button
      type="button"
      class="btn btn-submit"
      (click)="submitAddGeofence()"
      [disabled]="isSubmitting || addGeofenceForm.invalid">
      <span *ngIf="!isSubmitting">Create Geofence</span>
      <span *ngIf="isSubmitting">
        <i class="fa fa-spinner fa-spin"></i> Creating...
      </span>
    </button>
  </div>
</ng-template>

<!-- Custom Date Range Modal Overlay -->
<div class="modal-overlay" *ngIf="isCardOpen">
  <div class="modal-card">
    <button (click)="closeCard()" class="close-button">X</button>
    <div class="row">
      <div class="col-3 option-column" style="margin-left: -20px; margin-right: 12px;">
        <div style="margin-top: 20px;">
          <div class="option" [class.selected]="selectedOption === 'today'" (click)="handleOption('today')">
            Today
          </div>
          <div class="option" [class.selected]="selectedOption === 'weekly'" (click)="handleOption('weekly')">
            Current Week
          </div>
          <div class="option" [class.selected]="selectedOption === 'monthly'" (click)="handleOption('monthly')">
            Current Month
          </div>
          <div class="option" [class.selected]="selectedOption === 'lastmonth'" (click)="handleOption('lastmonth')">
            Previous Month
          </div>
          <div class="option" [class.selected]="selectedOption === 'customRange'" selected (click)="handleOption('customRange')">
            Custom Range
          </div>
        </div>
      </div>

      <div class="col-9" style="margin-top: 20px;">
        <!-- Display calendar for custom range -->
        <app-calendar (dateRangeSelected)="onCalendarDateRangeSelected($event)"></app-calendar>
      </div>
    </div>
  </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="delete-modal-overlay" *ngIf="showDeleteModal" (click)="cancelDelete()">
  <div class="delete-modal-card" (click)="$event.stopPropagation()">
    <div class="delete-modal-header">
      <div class="warning-icon">
        <i class="fa fa-exclamation-triangle"></i>
      </div>
      <h3 class="delete-modal-title">Permanent Deletion Warning</h3>
      <button type="button" class="modal-close-btn" (click)="cancelDelete()" aria-label="Close">
        <i class="fa fa-times"></i>
      </button>
    </div>

    <div class="delete-modal-body">
      <div class="geofence-name-box">
        <strong>{{ deleteGeofenceName }}</strong>
      </div>

      <p class="warning-text">
        You are about to <strong>permanently delete</strong> this geofence. This action will:
      </p>

      <ul class="consequences-list">
        <li>
          <i class="fa fa-times-circle"></i>
          Remove the geofence and all its configuration data
        </li>
        <li>
          <i class="fa fa-times-circle"></i>
          Remove all associated vehicle mappings
        </li>
        <li>
          <i class="fa fa-times-circle"></i>
          Delete all historical events and reports
        </li>
      </ul>

      <div class="danger-box">
        <i class="fa fa-exclamation-circle"></i>
        <span><strong>This action CANNOT be undone!</strong></span>
      </div>
    </div>

    <div class="delete-modal-footer">
      <button type="button" class="btn-cancel" (click)="cancelDelete()">
        <i class="fa fa-arrow-left"></i> Cancel
      </button>
      <button type="button" class="btn-delete" (click)="confirmDelete()">
        <i class="fa fa-trash"></i> Yes, Delete Permanently
      </button>
    </div>
  </div>
</div>
