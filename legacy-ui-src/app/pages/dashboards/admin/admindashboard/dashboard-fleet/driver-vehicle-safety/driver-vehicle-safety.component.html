<ngx-spinner bdColor="rgba(0,0,0,0.8)" size="large" color="#fff" type="ball-elastic-dots" [fullScreen]="true">
  <div class="custom-spinner">
    <img src="../../../../../assets/images/spinner3.svg" alt="Your Logo">
  </div>
  <div class="loading-text">Please wait, we are getting information...</div>
</ngx-spinner>
 <!--Main content-->
<div class="page-content page-content-main">
  <div class="row left-navigation">
    <!-- Left side menu-->
    <div class="col-xs-12 col-lg-2 navbar-side-menu">
      <app-sidebar></app-sidebar>
    </div>
    <!-- Left side menu end -->
    <!-- Right side menu -->
    <div class="col-xs-12 col-lg-10 content-right" style="margin-left: 2%; width: 100%;">
      <!-- Left side heading and right side Breadcrumb-->
      <div class="row">
        <div class="col-xs-12 col-lg-12">
          <span class="breadcrumb-left">
            <h1 class="login-headline heading-title">Car & Driver Safety
            </h1>
          </span>
          <span class="breadcrumb-right mr-8">
            <ol class="breadcrumb">
              <li class="breadcrumb-item">
                <a routerLink="/adlp/admin/admindashboard/dashboardfleet" class="breadcrumb-h6"><i
                    class="bx bx-home-circle"></i></a>
              </li>
              <li class="breadcrumb-item inactive-bread"> <a
                  routerLink="/adlp/admin/admindashboard/dashboardfleet">Dashboard</a></li>
              <li class="breadcrumb-item text-selected active-bread">Car & Driver Safety</li>
            </ol>
          </span>
        </div>
      </div>
      <!-- Left side heading and right side Breadcrumb end-->

      <!-- Consumer and Fleet Id Filter-->
      <div class="row consumer-pad justify-content-end my-2">
        <div class="col-xs-12 col-lg-2 mr-3" *ngIf="user !='role_user_fleet' && user !='role_Driver' && user != 'role_org_group'">
          <ng-select
            [items]="fleetList"
            bindLabel="name"
            bindValue="id"
            [searchable]="true"
            class="newSelect1"
            [clearable]="true"
            placeholder="Organization Id/Name"
            [(ngModel)]="fleetIdData"
            (change)="onFleetChange($event)">
            <ng-template ng-label-tmp let-item="item">
              {{ item.id }} - [{{ item.name }}]
            </ng-template>
            <ng-template ng-option-tmp let-item="item">
              {{ item.id }} - [{{ item.name }}]
            </ng-template>
          </ng-select>
        </div>
      </div>

      <div class="row consumer-pad">
          <div class="card-container">
              <div class="card-item card-item-height">
                <div class="card-heading">
                  <div class="row" style="height: 56px;">
                    <div class="col-xs-12 col-lg-6">
                      <img src="../../assets/images/summary.svg" alt="" class="card-heading-img" />Summary
                    </div>
                    <div class="col-xs-12 col-lg-6 d-flex justify-content-end">
                    <div class="fleet-dropdowm" style="width: 160px;">
                      <ng-select bindLabel="label" style="font-family: 'Poppins'!important;"
                          bindValue="value" placeholder="Select Time Period" [(ngModel)]="selectedPeriod"
                          (change)="onTimePeriodChangeData($event)"
                          class="newSelect  timePeriod current-month-dropdown ">
                          <ng-option *ngFor="let period of timePeriods" [value]="period.value">
                              {{ period.label }}
                          </ng-option>
                      </ng-select>
                  </div>
                </div>
                    <!-- <div class="col-xs-12 col-lg-6">
                      <h5 class="active-vehicle">Active Vehicles :
                        <span [ngClass]="{ 'loading-background': isLoading }" style="color:#000000!important">
                          {{
                          isDataNotFound
                          ? "No Data"
                          : (fleetSumamryTotalData?.totalActiveVehicles
                          | number : "1.0-0")
                          }}
                        </span>
                      </h5>
                    </div>  -->

                  </div>

                </div>
                <div class="cards-subsection">
                  <!-- <div class="header-card brdr-red">
                    <div class="header-card-text">
                      <span [ngClass]="{ 'loading-background': isloading2 }" style="line-height: 25px; width: 40%">
                        {{ fuelTripSummery.bestPerformingVehicle.lifetimeMileage | number:'1.2-2' }}
                        <ng-container *ngIf="fuelTripSummery.bestPerformingVehicle.vehicleName">
                          <span style="font-size: 12px; font-weight: 500; font-family: 'Poppins', sans-serif;">
                            mpg
                          </span>
                        </ng-container>
                      </span>
                    </div>
                    <div class="content-section-text">Best Performing Driver(<span>{{ fuelTripSummery.bestPerformingVehicle.vehicleName }}</span>)</div>
                  </div> -->


                  <div class="header-card brdr-fuel-consumed">
                    <div class="header-card-text">
                      <span [ngClass]="{ 'loading-background': isloading2 }" style="line-height: 25px; width: 40%">
                        {{  (carDriverSaftyTotalData?.totalSafetyIncidentsCombinedForAll ?? 0) | number:'1.2-2'  }}

                        <ng-container *ngIf="(carDriverSaftyTotalData?.totalSafetyIncidentsCombinedForAll ?? 0) > 0">
                          <span style="font-size: 12px; font-weight: 500; font-family: 'Poppins', sans-serif;">

                          </span>
                        </ng-container>
                      </span>
                    </div>
                    <div class="content-section-text">Safety Incidents</div>
                  </div>
                  <div class="header-card brdr-yellow">
                    <div class="header-card-text">
                      <span [ngClass]="{ 'loading-background': isloading2 }" style="line-height: 25px; width: 40%">
                        {{ (carDriverSaftyTotalData?.totalDistanceTravelledCombinedForAll ?? 0) | number:'1.2-2' }}
                        <ng-container *ngIf="(carDriverSaftyTotalData?.totalDistanceTravelledCombinedForAll ?? 0) > 0">

                          <span style="font-size: 12px; font-weight: 500; font-family: 'Poppins', sans-serif;">
                           miles
                          </span>
                        </ng-container>
                      </span>
                    </div>
                    <div class="content-section-text">Distance Travelled</div>
                  </div>

                  <div class="header-card brdr-blue">
                    <div class="header-card-text">
                      <span [ngClass]="{ 'loading-background': isloading2 }" style="line-height: 25px; width: 40%">
                        {{ (carDriverSaftyTotalData?.totalHoursTravelledCombinedForAll ?? 0) | number:'1.2-2' }}
                        <ng-container *ngIf="(carDriverSaftyTotalData?.totalHoursTravelledCombinedForAll ?? 0) > 0">
                          <span style="font-size: 12px; font-weight: 500; font-family: 'Poppins', sans-serif;">
                            Hours
                          </span>
                        </ng-container>
                      </span>
                    </div>
                    <div class="content-section-text">Hours Travelled</div>
                  </div>
                  <div class="header-card brdr-purple">
                    <div class="header-card-text">
                      <span [ngClass]="{ 'loading-background': isloading2 }" style="line-height: 25px; width: 40%">
                        {{ (carDriverSaftyTotalData?.averageSafetyScoreCombinedForAll ?? 0) | number:'1.2-2' }}
                        <ng-container *ngIf="(carDriverSaftyTotalData?.averageSafetyScoreCombinedForAll ?? 0) > 0">
                          <span style="font-size: 12px; font-weight: 500; font-family: 'Poppins', sans-serif;">

                          </span>
                        </ng-container>
                      </span>
                    </div>
                    <div class="content-section-text">Avg. Safety Score</div>
                  </div>
                  <div class="header-card brdr-green">
                    <div class="header-card-text">
                      <span [ngClass]="{ 'loading-background': isloading2 }" style="line-height: 25px; width: 40%">
                        {{ (carDriverSaftyTotalData?.averageMileageCombinedForAll ?? 0) | number:'1.2-2' }}
                        <ng-container *ngIf="(carDriverSaftyTotalData?.averageMileageCombinedForAll ?? 0) > 0">
                          <span style="font-size: 12px; font-weight: 500; font-family: 'Poppins', sans-serif;">

                          </span>
                        </ng-container>
                      </span>
                    </div>
                    <div class="content-section-text">Avg. Mileage</div>
                  </div>

                  <!-- <div class="header-card brdr-green">
                    <div class="header-card-text">
                      <span [ngClass]="{ 'loading-background': isloading2 }" style="line-height: 25px; width: 40%">
                          {{ avgFuelCost | number:'1.2-2' }}
                        <ng-container *ngIf="avgFuelCost">
                          <span style="font-size: 12px; font-weight: 500; font-family: 'Poppins', sans-serif;">
                            $
                          </span>
                        </ng-container>
                      </span>
                    </div>
                    <div class="content-section-text">Avg. Fuel Cost Per Mile</div>
                  </div> -->

                </div>
                <div class="cards-subsection pt-4">
                  <div class="card-item card-sub-item">
                    <div class="sub-text subtext-1">
                      <span class="text fs-5 fw-normal">Best Performing Driver</span> <br>
                      <span class="text-primary fs-5">{{ tripSummaryData[0]?.bestPerformingDriver?.vehicleName ?? 'NA' }}</span> <br>
                      <span class="text-success">{{ tripSummaryData[0]?.bestPerformingDriver?.driverName ?? 'NA' }}</span>
                    </div>


                    <div class="main-s-heading blues" [ngClass]="{ 'loading-background': isLoading }">
                      {{ (tripSummaryData[0]?.bestPerformingDriver?.driverScore ?? 0) | number:'1.2-2' }} Driver Score

                    </div>
                  </div>
                  <div class="card-item card-sub-item">
                    <div class="sub-text">
                      <span class="text fs-5 fw-normal">Worst Performing Driver </span><br>
                      <span class="text-primary fs-6">{{ tripSummaryData[0]?.worstPerformingDriver?.vehicleName ?? 'NA' }}</span> <br>
                      <span class="text-success fs-6">{{ tripSummaryData[0]?.worstPerformingDriver?.driverName ?? 'NA' }}</span>

                    </div>
                    <div class="main-s-heading oranges" [ngClass]="{ 'loading-background': isLoading }">
                      {{ (tripSummaryData[0]?.worstPerformingDriver?.driverScore ?? 0) | number:'1.2-2' }} Driver Score
                    </div>
                  </div>
                  <div class="card-item card-sub-item">
                    <div class="sub-text">
                      <span class="text fs-5 fw-normal">Most Driven Driver </span><br>
                      <span class="text-primary fs-5">{{ tripSummaryData[0]?.mostDrivenDriver?.vehicleName ?? 'NA' }}</span> <br>
                      <span class="text-success">{{ tripSummaryData[0]?.mostDrivenDriver?.driverName ?? 'NA' }}</span>
                    <div class="main-s-heading lightblues" [ngClass]="{ 'loading-background': isLoading }">
                      {{ (tripSummaryData[0]?.mostDrivenDriver?.totalDistance ?? 0) | number:'1.2-2' }} miles
                    </div>
                  </div>

                  </div>
                </div>

              </div>

            </div>
      <!-- Boxed for Total Data End-->
      <!-- VIN, OEM and satus filter -->
      <div class="row">
        <div class="col-lg-6"></div>
        <div class="col-lg-3 d-flex justify-content-end mt-4 mb-2">
          <input
            type="text"
            class="form-control"
            placeholder="Search Driver Name"
            [(ngModel)]="searchDriverName"
            (input)="filterByDriverName()"
            style="width: 100%; height: 45px;"
          />
        </div>
        <div class="col-lg-3 d-flex justify-content-end mt-4 mb-2">
          <ng-select
            [items]="vinList"
            bindLabel="alias"
            bindValue="vin"
            placeholder="Select Vehicle VIN"
            [(ngModel)]="selectedVin"
            (ngModelChange)="filterByVin()"
            class="input-vins font-common"
            [ngStyle]="{ 'width': '100%', 'height': '45px' }"
          >
            <ng-template ng-label-tmp let-item="item">
              {{ item.alias }} ({{ item.vin }})
            </ng-template>
            <ng-template ng-option-tmp let-item="item">
              {{ item.alias }} ({{ item.vin }})
            </ng-template>
          </ng-select>
        </div>
      </div>

      <!-- VIN, OEM and satus filter end -->
      <!-- Main data table-->
      <div class="row mr-table mr-6">
        <div class="col-lg-12 col-xs-12">
          <div class="table-wrapper">
            <div class="table-responsive table-b">
              <table class="table">
                <thead class="table-head">
                  <tr>
                    <th class="table-column-width5">Driver Name</th>
                    <th class="table-column-width">Vehicle Name</th>
                    <th class="table-column-width">VIN</th>
                    <th class="table-column-width7">DTC Alert</th>
                    <th class="table-column-width5">Total Collisions</th>
                    <th class="table-column-width5">Harsh Braking</th>
                    <th class="table-column-width5">Harsh Cornering</th>
                    <th class="table-column-width5">Harsh Acceleration</th>
                    <!-- <th class=" table-column-width5">Driver Violations</th> -->
                    <th class="table-column-width5">Low Tire Pressure Events</th>
                    <th class="table-column-width7">Top Speed</th>
                    <th class="table-column-width7">Total Miles Driven</th>
                    <th class="table-column-width7">Night Driving</th>
                    <th class="table-column-width7">Seat Belt Violations</th>
                     <th class="table-column-width7">Speed Violation</th>
                    <th class="table-column-width7">Driver Safety Score</th>

                  </tr>
                </thead>

                <tbody>
                  <ng-container *ngIf="filteredTrips?.length > 0; else noDataTemplate">
                    <ng-container *ngFor="let trips of filteredTrips; let i = index">
                      <tr class="bor-none">

                        <td>
                          <ng-container *ngIf="trips?.driverName !=='Unknown'; else noVehicle">
                            {{ trips?.driverName }}
                          </ng-container>
                          <ng-template #noVehicle>
                            <a [routerLink]="['/adlp/admin/admindashboard/manageDriver/viewDriver']"
                               style="color: red; text-decoration: underline;">
                              Assign Driver
                            </a>
                          </ng-template>
                        </td>
                        <td>{{ trips?.vehicleName }}</td>
                        <td>{{ trips?.vin }}</td>

                        <!-- DTC Alert -->
                        <td class="text-center">
                          <span [ngClass]="{'text-danger': trips?.dtcAlert > 0}">
                            {{ trips?.dtcAlert || 'No Alert' }}
                          </span>
                        </td>
                        <td>{{ trips?.totalCollisions }}</td>
                        <td> {{ trips?.totalHarshBraking}} </td>
                        <td> {{ trips?.totalHarshCornering}} </td>
                        <td> {{ trips?.totalAcceleration}} </td>
                        <!-- <td> {{ trips?.totalDriverViolations}} </td> -->
                        <!-- <td class="text-center">
                          <ng-container *ngIf="trips?.tirePressure">
                            <ng-container *ngIf="trips?.tirePressure?.frontLeftStatus === 'LOW' ||
                                                 trips?.tirePressure?.frontRightStatus === 'LOW' ||
                                                 trips?.tirePressure?.rearLeftStatus === 'LOW' ||
                                                 trips?.tirePressure?.rearRightStatus === 'LOW'; else checkHigh">
                              ‚ùå LOW
                            </ng-container>
                            <ng-template #checkHigh>
                              <ng-container *ngIf="trips?.tirePressure?.frontLeftStatus === 'HIGH' ||
                                                   trips?.tirePressure?.frontRightStatus === 'HIGH' ||
                                                   trips?.tirePressure?.rearLeftStatus === 'HIGH' ||
                                                   trips?.tirePressure?.rearRightStatus === 'HIGH'; else showGood">
                                üî∫ HIGH
                              </ng-container>
                            </ng-template>
                            <ng-template #showGood>
                              ‚úÖ GOOD
                            </ng-template>
                          </ng-container>
                        </td> -->

                          <td>
                            <ng-container *ngIf="trips.vin === 'JTDBCMFE5R3030603'">
                              3
                            </ng-container>

                            <ng-container *ngIf="trips.vin === '1FTYR3XM6FKB18960'">
                              0
                            </ng-container>


                            <ng-container *ngIf="trips.vin === '1G1FZ6S04L4134161'">
                              1
                            </ng-container>
                          </td>




                           <!-- Top Speed -->
                           <td class="text-center">{{ trips?.maxSpeed | number: '1.2-2' }} mph</td>
                        <!-- Average Mileage -->
                        <td class="text-center">
                          {{ trips?.totalDistanceTravelled | number: '1.2-2'}} miles

                        </td>



                        <!-- Night Driving -->
                        <td class="text-center">{{ trips?.nightDrivingMiles | number: '1.2-2' }} miles</td>

                        <!-- Total Seat Belt Violations -->
                        <td class="text-center">
                          {{ (trips?.totalSeatbeltViolations ?? 0) | number: '1.0-0' }}
                        </td>

                        <td>{{ trips?.totalHighSpeedDistance  ?? 0}}</td>


                        <!-- Driver Safety Score -->
                        <td class="text-center">
                          <span [ngClass]="{
                            'text-success': trips?.driverSafetyScore >= 80,
                            'text-warning': trips?.driverSafetyScore >= 60 && trips?.driverSafetyScore < 80,
                            'text-danger': trips?.driverSafetyScore < 60
                          }">
                            {{ trips?.driverSafetyScore | number: '1.2-2' }}%
                          </span>
                        </td>
                      </tr>
                    </ng-container>
                  </ng-container>

                  <!-- No Data Found Message -->
                  <ng-template #noDataTemplate>
                    <tr>
                      <td colspan="11" class="text-center">
                        <h5 class="heading-c">No Data Found ...</h5>
                      </td>
                    </tr>
                  </ng-template>
                </tbody>
              </table>

            </div>
          </div>
        </div>
      </div>
      <!-- Main data table end-->
      <!-- Pagination -->
      <div class="mt-2 text-end pagination-h">
        <!-- Number Pagination-->
        <span *ngIf="pages?.length <=9" class="f-le">
          <div>
            <nav class="isolate inline-flex -space-x-px rounded-md shadow-sm pag-color" aria-label="Pagination">
              <a (click)="selectPages(pageNumber - 1)" href="javascript:(Void)" [class.disabled]="pageNumber == 1"
                class="page pointer relative inline-flex items-center rounded-l-md px-2 py-2 text-sm font-medium text-gray-500 hover:bg-gray-50 focus:z-20">
                <span class="sr-only">Previous</span>
                <img src="../../../../../assets/images/left-img.svg">
              </a>


              <ng-container *ngFor="let page of pages">
                <a [class.isActive]="page == pageNumber" href="javascript:(void)" [ngClass]="{'pointer' : page != '...'}"
                  aria-current="page" (click)="selectPages(page)" class=" px-4 py-2 pageination-number">{{page}}
                </a>
              </ng-container>


              <a (click)="selectPages(pageNumber + 1)" [class.disabled]="pageNumber == totalPages"
                class=" page pointer relative inline-flex items-center rounded-r-md px-2 py-2 text-sm font-medium text-gray-500 hover:bg-gray-50 focus:z-20">
                <span class="sr-only">Next</span>
                <img src="../../../../../assets/images/right.svg">
              </a>
            </nav>
          </div>
        </span>
        <span *ngIf="pages?.length >9" class="f-le">
          <div>
            <nav class="isolate inline-flex -space-x-px rounded-md shadow-sm" aria-label="Pagination">
              <a (click)="selectPages(pageNumber - 1)" [class.disabled]="pageNumber == 1"
                class="page pointer relative inline-flex items-center rounded-l-md px-2 py-2 text-sm font-medium text-gray-500 hover:bg-gray-50 focus:z-20">
                <span class="sr-only">Previous</span>
                <img src="../../../../../assets/images/left-img.svg">
              </a>

              <ng-container *ngFor="let page of pages">
                <a [class.isActive]="page == pageNumber" *ngIf="( (page < pages.length && page  > 1))" aria-current="page"
                  (click)="selectPages(page)"
                  [ngStyle]="{'display': ((page > pageNumber+1 ||  page < pageNumber-1) && page < (pages.length)) ? 'none':''}"
                  class=" px-4 py-2 pageination-number">{{page}}
                </a>
              </ng-container>

              <ng-container *ngIf="pageNumber < (pages.length-2)">
                <a aria-current="page" (click)="selectPages(pageNumber+1)"
                  class="page relative z-10 inline-flex items-center  px-4 py-2 text-sm font-medium text-indigo-600 focus:z-20 active:bg-blue-700 focus:bg-blue-500 hover:bg-blue-700 hover:text-white ">{{"."}}
                </a>
              </ng-container>

              <ng-container>
                <a aria-current="page" [class.isActive]="(pageNumber == pages.length )" (click)="selectPages(pages.length)"
                  class=" px-4 py-2 pageination-number">{{pages.length}}
                </a>
              </ng-container>

              <ng-container *ngFor="let page of pages">
                <a [class.isActive]="page == pageNumber" class="page-display" aria-current="page"
                  (click)="selectPages(page)" class=" px-4 py-2 pageination-number">{{page}}
                </a>
              </ng-container>


              <a (click)="selectPages(pageNumber + 1)" [class.disabled]="pageNumber == totalPages"
                class=" page relative inline-flex items-center rounded-r-md border border-gray-300 bg-white px-2 py-2 text-sm font-medium text-gray-500 hover:bg-gray-50 focus:z-20">
                <span class="sr-only">Next</span>
                <img src="../../../../../assets/images/right.svg">
              </a>
            </nav>
          </div>
        </span>
        <!-- Number Pagination End-->
         <!-- Page Size Pagination-->
        <span class="f-ri">
          <select class="form-select" (change)="selectPage($event.target.value)" [(ngModel)]="pageSize">
            <option value="5">5</option>
            <option value="10">10</option>
            <option value="20">20</option>
            <option value="40">40</option>
            <option value="80">80</option>
            <option value="100">100</option>
          </select>
        </span>
        <span class="pageination">Per Page</span>
         <!-- Page Size Pagination End-->
      </div>
      <!-- Pagination End -->
    </div>
    <!-- Right side menu end-->
  </div>
</div>
<!--Main content-->
<!--Failure reason when click on info-->
<ng-template #remarks let-modal class="modal-width">
  <div class="modal-header">
    <h5 class="modal-title mt-0 font-weight-bold">Failed Reason</h5>
    <button type="button" class="btn-close" (click)="modal.dismiss('Cross click')" aria-hidden="true"></button>
  </div>
  <div class="modal-body">
    <div class="row">
      <div class="col-xs-12 col-lg-12 failure-box">
        {{selectedFailureReason}}
      </div>
    </div>
  </div>
</ng-template>
<!--Failure reason when click on info end-->

<div class="modal-overlay" *ngIf="isCardOpen">
  <div class="modal-card">
      <button (click)="closeCard()" class="close-button">X</button>
      <div class=" row">
          <div class="col-3 option-column" style="    margin-left: -20px;
  margin-right: 12px;">
              <div style="margin-top: 20px;">
                  <div class="option" [class.selected]="selectedOption === 'yesterday'"
                      (click)="handleOption('yesterday')">Yesterday</div>
                  <div class="option" [class.selected]="selectedOption === 'weekly'" (click)="handleOption('weekly')">
                      Current Week</div>
                  <div class="option" [class.selected]="selectedOption === 'monthly'"
                      (click)="handleOption('monthly')">Current Month</div>
                  <div class="option" [class.selected]="selectedOption === 'lastmonth'"
                      (click)="handleOption('lastmonth')">Previous Month</div>
                  <div class="option" [class.selected]="selectedOption === 'customRange'" selected
                      (click)="handleOption('customRange')">Custom Range</div>
              </div>
          </div>

          <div class="col-9" style="margin-top:20px;">

              <!-- Display calendar only if 'custom-range' is selected -->
              <app-calendar (dateRangeSelected)="onDateRangeSelected($event);closeCard()"></app-calendar>
          </div>
      </div>
  </div>
</div>
