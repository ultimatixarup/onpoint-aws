<ngx-spinner bdColor="rgba(0,0,0,0.8)" size="large" color="#fff" type="ball-elastic-dots" [fullScreen]="true">
  <div class="custom-spinner">
    <img src="../../../../../assets/images/spinner3.svg" alt="Loading">
  </div>
  <div class="loading-text">Please wait, we are getting information...</div>
</ngx-spinner>

<!--Main content-->
<div class="page-content page-content-main">
  <div class="row" style="margin-left: 0px; margin-right: 0px;">
    <!-- Left side menu-->
    <div class="col-xs-12 col-lg-2 navbar-side-menu">
      <app-sidebar></app-sidebar>
    </div>
    <!-- Left side menu end -->

    <!-- Right side menu -->
    <div class="col-xs-12 col-lg-12">
      <!-- Left side heading and right side Breadcrumb-->
      <div class="row">
        <div class="col-xs-12 col-lg-12">
          <span class="breadcrumb-left">
            <h1 class="login-headline heading-title">Vehicle Health</h1>
          </span>
          <span class="breadcrumb-right mr-8">
            <ol class="breadcrumb">
              <li class="breadcrumb-item">
                <a routerLink="/adlp/admin/admindashboard/dashboardfleet" class="breadcrumb-h6">
                  <i class="bx bx-home-circle"></i>
                </a>
              </li>
              <li class="breadcrumb-item inactive-bread">
                <a routerLink="/adlp/admin/admindashboard/dashboardfleet">Dashboard</a>
              </li>
              <li class="breadcrumb-item text-selected active-bread">Vehicle Health</li>
            </ol>
          </span>
        </div>
      </div>

      <!-- Fleet Filter-->
      <div class="row consumer-pad justify-content-end my-2">
        <div class="col-xs-12 col-lg-2 mr-3"
             *ngIf="user !='role_user_fleet' && user !='role_Driver' && user != 'role_org_group'">
          <ng-select
            [items]="fleetList"
            bindLabel="name"
            bindValue="id"
            [searchable]="true"
            class="newSelect1"
            [clearable]="true"
            placeholder="Organization Id/Name"
            [(ngModel)]="fleetIdData"
            (change)="onFleetChange($event)">
            <ng-template ng-label-tmp let-item="item">
              {{ item.id }} - [{{ item.name }}]
            </ng-template>
            <ng-template ng-option-tmp let-item="item">
              {{ item.id }} - [{{ item.name }}]
            </ng-template>
          </ng-select>
        </div>
      </div>
      <!-- Fleet Filter end-->

      <!-- Summary Cards -->
      <div class="row consumer-pad">
        <div class="card-container">
          <div class="card-item card-item-height">
            <div class="card-heading">
              <div class="row" style="height: 56px;">
                <div class="col-xs-12 col-lg-12">
                  <img src="../../assets/images/summary.svg" alt="" class="card-heading-img" />Summary
                </div>
              </div>
            </div>

            <div class="cards-subsection">
              <div class="header-card brdr-green">
                <div class="header-card-text">
                  <span [ngClass]="{ 'loading-background': loading }" style="line-height: 25px; width: 40%">
                    {{ totalActiveVehicles }}
                  </span>
                </div>
                <div class="content-section-text">Vehicle Active</div>
              </div>

              <div class="header-card brdr-red">
                <div class="header-card-text">
                  <span [ngClass]="{ 'loading-background': loading }" style="line-height: 25px; width: 40%">
                    {{ vehiclesNeedAttention }}
                  </span>
                </div>
                <div class="content-section-text">Vehicle Need Attention</div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <!-- Summary Cards End -->

      <!-- Filters and Search -->
      <div class="row consumer-pad mt-3">
        <div class="col-xs-12 col-lg-12">
          <div class="card-item">
            <div class="card-heading">
              <div class="row">
                <div class="col-xs-12 col-lg-4">
                 Vehicle Health Details
                </div>
                <div class="col-xs-12 col-lg-8 d-flex justify-content-end align-items-center">
                  <!-- Health Status Filter -->
                  <div class="mr-3" style="width: 200px;">
                    <ng-select
                      [items]="healthStatusOptions"
                      bindLabel="label"
                      bindValue="value"
                      [searchable]="false"
                      [clearable]="true"
                      placeholder="Filter by Health"
                      [(ngModel)]="selectedHealthStatus"
                      (change)="onHealthStatusChange()"
                      class="newSelect">
                    </ng-select>
                  </div>

                  <!-- VIN Filter -->
                  <div style="width: 250px;">
                    <ng-select
                      [items]="vinList"
                      bindLabel="alias"
                      bindValue="vin"
                      placeholder="Select Vehicle VIN"
                      [(ngModel)]="selectedVin"
                      (ngModelChange)="filterByVin()"
                      [searchable]="true"
                      [clearable]="true"
                      class="newSelect">
                      <ng-template ng-label-tmp let-item="item">
                        {{ item.alias }}
                      </ng-template>
                      <ng-template ng-option-tmp let-item="item">
                        {{ item.alias }}
                      </ng-template>
                    </ng-select>
                  </div>
                </div>
              </div>
            </div>

            <!-- Table -->
            <div class="table-responsive mt-3">
              <table class="table table-hover">
                <thead>
                  <tr>
                    <th style="width: 50px;"></th>
                    <th>VIN</th>
                    <th>Vehicle Name</th>
                    <th>Odometer Reading</th>
                    <th>Battery Level (V)</th>
                    <th>Tire Pressure (FR/FL/RL/RR) in PSI</th>
                    <th>Fuel Level (Gal)</th>
                    <th>Overall Health</th>
                  </tr>
                </thead>
                <tbody>
                  <ng-container *ngIf="!isDataNotFound && !loading">
                    <ng-container *ngFor="let vehicle of getPaginatedData(); let i = index">
                      <!-- Main Row -->
                      <tr [class.expanded-row]="isRowExpanded(i)">
                        <td>
                          <i
                            [class.bx]="true"
                            [class.bx-plus]="!isRowExpanded(i)"
                            [class.bx-minus]="isRowExpanded(i)"
                            class="expand-icon"
                            (click)="toggleRowExpansion(i)">
                          </i>
                        </td>
                        <td>{{ vehicle.vin }}</td>
                        <td>{{ vehicle.vehicleName }}</td>
                        <td>{{ vehicle.odometerReading | number:'1.0-0' }} mi</td>
                        <td>
                            <ng-container *ngIf="vehicle.batteryLevel !== 'N/A'; else naTemplate">
                                {{ vehicle.batteryLevel | number:'1.1-1' }} V
                            </ng-container>
                            <ng-template #naTemplate>N/A</ng-template>
                        </td>
                        <td>
                          {{ vehicle.tirePressure.frontRight }}/{{ vehicle.tirePressure.frontLeft }}/{{ vehicle.tirePressure.rearLeft }}/{{ vehicle.tirePressure.rearRight }}
                        </td>
                        <td>
                            <ng-container *ngIf="vehicle.fuelLevel !== 'N/A'; else naTemplate">
                                {{ vehicle.fuelLevel | number:'1.1-1' }} gal
                            </ng-container>
                            <ng-template #naTemplate>N/A</ng-template>
                        </td>
                        <td>
                          <span
                            class="health-badge"
                            [ngClass]="getHealthStatusClass(vehicle.overallHealth)">
                            {{ getHealthStatusText(vehicle.overallHealth) }}
                          </span>
                        </td>
                      </tr>

                      <!-- Expanded Details Row -->
                      <tr *ngIf="isRowExpanded(i)" class="expanded-details-row">
                        <td colspan="8">
                          <div class="expanded-details">
                            <table class="table table-sm details-table">
                              <thead>
                                <tr>
                                  <th>Avg Coolant Temp</th>
                                  <th>Max Oil Temp</th>
                                  <th>Min Oil Temp</th>
                                  <th>DTC Code Category</th>
                                  <th>DTC Code</th>
                                  <th>DTC Description</th>
                                  <th>Oil Life (in %)</th>
                                </tr>
                              </thead>
                              <tbody>
                                <tr>
                                  <td>{{ vehicle.coolantTemp?.avg || 'N/A' }}°F</td>
                                  <td>{{ vehicle.oilTemp?.max || 'N/A' }}°F</td>
                                  <td>{{ vehicle.oilTemp?.min || 'N/A' }}°F</td>
                                  <td>
                                    <span *ngIf="vehicle.dtcCodes && vehicle.dtcCodes.length > 0">
                                      {{ vehicle.dtcCodes[0].category }}
                                    </span>
                                    <span *ngIf="!vehicle.dtcCodes || vehicle.dtcCodes.length === 0">N/A</span>
                                  </td>
                                  <td>
                                    <span *ngIf="vehicle.dtcCodes && vehicle.dtcCodes.length > 0">
                                      {{ vehicle.dtcCodes[0].code }}
                                    </span>
                                    <span *ngIf="!vehicle.dtcCodes || vehicle.dtcCodes.length === 0">N/A</span>
                                  </td>
                                  <td>
                                    <span *ngIf="vehicle.dtcCodes && vehicle.dtcCodes.length > 0">
                                      {{ vehicle.dtcCodes[0].description }}
                                    </span>
                                    <span *ngIf="!vehicle.dtcCodes || vehicle.dtcCodes.length === 0">N/A</span>
                                  </td>
                                  <td>{{ vehicle.oilLife }}%</td>
                                </tr>
                              </tbody>
                            </table>
                          </div>
                        </td>
                      </tr>
                    </ng-container>
                  </ng-container>

                  <!-- Loading State -->
                  <tr *ngIf="loading">
                    <td colspan="8" class="text-center">
                      <div class="loading-message">Loading data...</div>
                    </td>
                  </tr>

                  <!-- No Data State -->
                  <tr *ngIf="isDataNotFound && !loading">
                    <td colspan="8" class="text-center">
                      <div class="no-data-message">No vehicle health data available</div>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>

            <!-- Pagination -->
            <div class="pagination-container" *ngIf="!isDataNotFound && !loading && totalPages > 1">
              <nav aria-label="Page navigation">
                <ul class="pagination justify-content-center">
                  <li class="page-item" [class.disabled]="pageNumber === 1">
                    <a class="page-link" (click)="previousPage()" href="javascript:void(0)">Previous</a>
                  </li>
                  <li class="page-item"
                      *ngFor="let page of pages"
                      [class.active]="page === pageNumber">
                    <a class="page-link" (click)="goToPage(page)" href="javascript:void(0)">{{ page }}</a>
                  </li>
                  <li class="page-item" [class.disabled]="pageNumber === totalPages">
                    <a class="page-link" (click)="nextPage()" href="javascript:void(0)">Next</a>
                  </li>
                </ul>
              </nav>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
